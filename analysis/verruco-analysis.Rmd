---
title: "Freshwater Verrucocmicrobia"
author: "Edna Chiang"
date: "July 6, 2015"
output: html_document
---


### Load Libraries
```{r}
library(phyloseq)
packageVersion("phyloseq")
library(ggplot2)
library(ape)
library(vegan)
library(plyr)
library(dplyr)
library(scales)
library(grid)
library(reshape2)
theme_set(theme_bw())
set.seed(1)
```

### Import Data
```{r}
# files
sharedfile = "verruco.shared"
taxfile = "verruco.cons.taxonomy"
mapfile = "verruco_metadata_duplicates.csv"

# Import mothur data
mothurdata = import_mothur(
  mothur_shared_file = sharedfile, 
  mothur_constaxonomy_file = taxfile
)
    
# Add the OTU number as a column in the taxonomy file
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
  row.names(tax_table(mothurdata)))

# Rename the taxonomy columns
colnames(tax_table(mothurdata)) <- 
  c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")
  
# Import sample metadata and transform into sample_data class
map <- read.csv(mapfile)

# Convert map to sample_data class
# Merge mothurdata object with sample_data
map <- sample_data(map)
rownames(map) <- map$SampleID
mothur.merge <- merge_phyloseq(mothurdata, map)
```



### Filter data
```{r}
# Filter out non-samples (i.e. water, mock) and non-bacteria
verruco <-
  mothur.merge %>%
    subset_taxa(
      Kingdom == "Bacteria" &
      Family != "mitochondria" &
      Class != "Chloroplast"
    ) %>%
    subset_samples(
      Blank == "no" &
      !Fraction %in% c("cFree", "cParticle") & 
      Lake != "Huron" 
    ) 

# Also prune out taxa which were only present in removed samples
verruco <- prune_taxa(taxa_sums(verruco) > 0, verruco)

```


### Trim & normalize data based on # of reads/sequence depth
```{r}
# Look at # of reads
ggplot(data.frame(sum = sample_sums(verruco)), aes(sum)) + 
  geom_histogram(colour = "white", fill = "blue") + 
  ggtitle("Sample read counts") + 
  xlab("total sequences")

# Min, Mean, Max of sample read counts
min(sample_sums(verruco))
mean(sample_sums(verruco))
max(sample_sums(verruco))
```


### Merge Duplicates & create new phyloseq object
```{r}
# Merges duplicates
verr.dupmerge <- merge_samples(verruco, "Duplicates")

## Fix metadata of merged duplicates 
# Grab unique lines (first entry) from verruco phyloseq object metadata
unique.idx <- !(duplicated(sample_data(verruco)$Duplicates))
duplicate.metadata <- sample_data(verruco)[unique.idx, ]

# Fix SampleID and rownames
duplicate.metadata$SampleID <- duplicate.metadata$Duplicates
rownames(duplicate.metadata) <- duplicate.metadata$Duplicates

# Assign new metadata to phyloseq object
sample_data(verr.dupmerge) <- duplicate.metadata

```


### Trim & normalize data based on # of reads/sequence depth
```{r}
# Look at # of reads
ggplot(data.frame(sum = sample_sums(verr.dupmerge)), aes(sum)) + 
  geom_histogram(colour = "white", fill = "blue") +
  ggtitle("Sample read counts") + 
  xlab("total sequences")

# Mean, max and min of sample read counts
min(sample_sums(verr.dupmerge))
mean(sample_sums(verr.dupmerge))
max(sample_sums(verr.dupmerge))

```

```{r}

# Normalize our dataset!
scaled <- scale_reads(manual_merged)   ### Scaled to 10,468

# Let's visualized our normalized dataset
ggplot(data.frame(sum = sample_sums(scaled)), aes(sum)) + 
  geom_histogram(colour = "black", fill = "deeppink") +
  ggtitle("Sample read counts") + 
  xlab("total sequences")

```



### Let's take a look at the phyla in our normalized dataset
```{r, fig.height = 5, fig.width = 8.5}

# Merges things that have the same taxanomic rank
good_phylum <- tax_glom(final, taxrank = "Phylum")

# Transforms each merged phylum count to rel abun
phylum.99 = transform_sample_counts(good_phylum, function(x){(x/sum(x))*100})

# If a phylum has <1% rel abun, change that to 0%
otu_table(phylum.99)[otu_table(phylum.99) < 0.01] <- 0

# Remove anything with 0% rel abun
phylum.99 = prune_taxa(taxa_sums(phylum.99) > 0, phylum.99)

# Create rank abundance of OTUs
barplot(sort(taxa_sums(phylum.99),TRUE)[1:5]/nsamples(phylum.99),
  las = 2,
  cex.axis = 0.7, 
  space = F, 
  names.arg = c("Proteobacteria", "Bacteroidetes","Actinobacteria", "Verrucomicrobia", "Cyanobacteria"), 
  col = c("khaki1", "mediumorchid3", "firebrick3", "lightslateblue", "chartreuse3"), 
  main = "Top 5 Bacterial Phyla", 
  xlab = "Phylum", 
  ylab = "Relative Abundance (%)", 
  ylim = c(0, 35), 
  las = 0
)
```

### STACKED BAR PLOT OF GROUPS
```{r}
################# TIME TO CREATE STACKED BAR PLOT OF GROUPS #################

# Merge samples by group
phy.group <- merge_samples(phylum.99, "Group")

## But this only sums them
phy.samp <- data.frame(sample_data(phylum.99))

# Average groups
phy.otu <- data.frame(otu_table(phy.group))
phy <- data.frame(tax_table(phy.group))
phy.otu[1,] <- (phy.otu[1,]/64)
    ## Averaging Estuary
phy.otu[2,] <- (phy.otu[2,]/117)
    ## Averaging Inland
phy.otu[3,] <- (phy.otu[3,]/34)
    ## Averaging Laurentian
#colnames(phy.otu) <- c("Proteobacteria","Actinobacteria","Cyanobacteria","Bacteroidetes","Planctomycetes","Chloroflexi","Verrucomicrobia","Armatimonadetes","NPL-UPA2","Chlorobi","Gemmatimonadetes","Acidobacteria","Candidate_division_OP3","Nitrospirae","Candidate_division_OD1","Spirochaetae","Candidate_division_OP8","Chlamydiae","Lentisphaerae","BD1-5","TM6","unclassified","Firmicutes", "Candidate_division_WS3","Fibrobacteres","Candidate_division_SR1")
tphy.otu <- t(phy.otu)
phy.otu <- otu_table(tphy.otu, taxa_are_rows = T)
phy.tax <- tax_table(phy.group)
phy.samp <- sample_data(phy.group)
phy.group.merge <- merge_phyloseq(phy.tax, phy.otu, phy.samp)
    ## Makes new phyloseq object of 3 groups: Estuary, Inland, Laurentian
        
########### MAKE OBJECT TO BE USED IN GGPLOT ###########
phylum_long <- psmelt(phy.group.merge)
phylum_sort <- arrange(phylum_long, Phylum)
phylum_sort$Sample <- factor(phylum_sort$Sample, levels = c("Laurentian", "Estuary", "Inland"))

# Set phylum plotting colors
phylum.colors <- c(Acidobacteria = "lightblue1", Actinobacteria = "firebrick3", Armatimonadetes = "salmon", "BD1-5" = "gold", Bacteroidetes = "mediumorchid3", "Candidate_division_OD1" = "tan", "Candidate_division_OP3" = "grey76", "Candidate_division_OP8" = "darkolivegreen1", "Candidate_division_SR1" = "cornflowerblue", "Candidate_division_WS3" = "purple4", Clamydiae = "violetred1", Chlorobi = "goldenrod", Chloroflexi = "firebrick4", Cyanobacteria = "chartreuse3", Fibrobacteres = "black", Firmicutes = "white", Gemmatimonadetes = "grey", Lentisphaerae = "yellow", "NPL-UPA2" = "hotpink", Nitrospirae = "midnightblue", Planctomycetes = "deepskyblue", Proteobacteria = "khaki1", Spirochaetae = "coral1", "TM6" = "slategray1", Verrucomicrobia = "lightslateblue", unclassified = "green4")
  
  #c(Proteobacteria = "deepskyblue", Actinobacteria = "royalblue", Cyanobacteria = "chartreuse3", Bacteroidetes = "darkorange", Planctomycetes = "mediumorchid3", Chloroflexi = "darkgreen", Verrucomicrobia = "purple4", Armatimonadetes = "red", "NPL-UPA2"="#652926", Chlorobi = "cyan2", Gemmatimonadetes = "black", Acidobacteria = "grey76", "Candidate_division_OP3" = "hotpink", Nitrospirae = "blue", "Candidate_division_OD1" = "brown", Spirochaetae = "gold3", "Candidate_division_OP8" = "goldenrod1", Chlamydiae = "violet", Lentisphaerae = "yellow1", "BD1-5" = "chartreuse", "TM6" = "olivedrab", unclassified = "grey", Firmicutes = "blue4", "Candidate_division_WS3"= "magenta", Fibrobacteres = "darkred", "Candidate_division_SR1" = "tan3" )
  
  #c(Acidobacteria = "grey26", Actinobacteria = "royalblue", Alphaproteobacteria = "plum2", Armatimonadetes = "red", Bacteroidetes = "darkorange", "BD1-5" = "chartreuse", Betaproteobacteria = "slateblue2", "Candidate_division_BRC1" = "violetred4", "Candidate_division_OD1" = "#6DDE88", "Candidate_division_OP3" = "hotpink", "Candidate_division_OP8" = "goldenrod1",  "Candidate_division_SR1" = "tan3", "Candidate_division_TM7" = "skyblue1", "Candidate_division_WS3" = "magenta", Chlamydiae="violet", Chlorobi="cyan2", Chloroflexi="darkgreen", Cyanobacteria = "chartreuse3", Deferribacteres = "slateblue3", "Deinococcus-Thermus" = "violetred", Deltaproteobacteria = "deepskyblue", Elusimicrobia = "yellow3", Epsilonproteobacteria = "lightskyblue", Fibrobacteres = "darkred", Firmicutes = "blue4", Fusobacteria = "slateblue1", Gammaproteobacteria = "steelblue4", Gemmatimonadetes="black", Lentisphaerae = "yellow1", "NPL-UPA2"="#652926", Planctomycetes = "mediumorchid3", Proteobacteria = "deepskyblue", Spirochaetae = "gold3", Tenericutes="pink", Thermotogae = "chocolate1", TM6 = "olivedrab", unclassified = "grey", Verrucomicrobia = "purple4", "WCHB1-60" = "palegreen")

# GGPLOT it

tiff("stackedbar.tiff", width = 7, height = 8, units = "in", res = 500)
ggplot(phylum_sort, aes(x=Sample, y=Abundance, fill=Phylum)) +
          geom_bar(stat="identity", position="fill", color="black") +
          scale_y_continuous(labels = percent_format()) +
          scale_fill_manual(values = phylum.colors, name="Phylum") + 
          theme(axis.title.x = element_text(size=16, face = "bold"),
                axis.text.x = element_text(angle=50, colour = "black", vjust=1, hjust = 1, size=14),
                axis.text.y = element_text(colour = "black", size=14),
                axis.title.y = element_text(size=16, face="bold"),
                plot.title = element_text(size = 18, face="bold"),
                legend.title = element_text(size=14),
                legend.text = element_text(size = 13),
                legend.position="right") +
          guides(fill = guide_legend(reverse = TRUE, keywidth = 1, keyheight = 1)) + 
          xlab("Group") +
          ylab("Relative Abundance (taxa>0.1%)") +
          ggtitle("Lake Bacterial Community Composition")
dev.off()

```

### LOOKING AT INTRA-VERRUCO COMMUNITY
```{r}
phy.Ver <- subset_taxa(phylum.99, Phylum == "Verrucomicrobia")
# min, max, & mean
mins <- min(sample_sums(phy.Ver))
paste(c("The minimum sample read count is", mins))
means <- mean(sample_sums(phy.Ver))
paste(c("The mean sample read count is", means))
maxs <- max(sample_sums(phy.Ver))
paste(c("The max sample read count is", maxs))

# Merge samples by Group
phy.group.Ver <- merge_samples(phy.Ver, "Group")

# Average groups
group.Ver <- data.frame(otu_table(phy.group.Ver))
group.Ver[1,] <- (group.Ver[1,]/54)
    ## Averaging Estuary
group.Ver[2,] <- (group.Ver[2,]/117)
    ## Averaging Inland
group.Ver[3,] <- (group.Ver[3,]/45)
    ## Averaging Laurentian
#tgroup.Ver <- t(group.Ver)
#tgroup.Ver <- data.frame(tgroup.Ver)
group.Ver$Lake_Type <- rownames(group.Ver)

# Really crappy bar plot
ggplot(data = group.Ver, aes(x = Lake_Type, y = Otu000064)) +
  geom_bar(stat = "identity", fill = "dark grey", colour = "black") 

# Unclassifed phylum
phy.unclas <- subset_taxa(phylum.99, Phylum == "unclassified")
# min, max, & mean
mins <- min(sample_sums(phy.unclas))
paste(c("The minimum sample read count is",mins))
means <- mean(sample_sums(phy.unclas))
paste(c("The mean sample read count is",means))
maxs <- max(sample_sums(phy.unclas))
paste(c("The max sample read count is",maxs))


```


### Separate out Verrucos
```{r}
# Phyloseq object of ALL Verruco OTUs
Ver <- subset_taxa(final, Phylum == "Verrucomicrobia")

# For additional analysis -> Removing Sediment samples
phy.Ver.water <- subset_samples(phy.Ver, Fraction != "Sediment")

```

### Making phy.Ver normal
```{r}
phy.Ver.otu <- as.numeric(otu_table(phy.Ver))
hist(phy.Ver.otu,
  breaks = seq(0, 0.5, by = 0.025), 
  xlab = "Relative Abundance", 
  main = "Original Histogram")
    ## NOT NORMAL
    ## SKEWED RIGHT
qqnorm(phy.Ver.otu)
qqline(phy.Ver.otu)
    ## NOT NORMAL

# Test for normality
shapiro.test(phy.Ver.otu)
    ## DEF not normal (p-value = 0)
ks.test(phy.Ver.otu, "pnorm", mean = mean(phy.Ver.otu), sd = sd(phy.Ver.otu))
    # NOT NORMAL (p-value = 0.01615)

##### Log Transformation #####
log.ver <- log(phy.Ver.otu)
hist(log.ver, breaks=18, main = "Log-Transformed Histogram", xlab = "Log(Relative Abundance)")
    ## LOOKS BEAUTIFUL!
qqnorm(log.ver)
qqline(log.ver)
    ## Looks slightly better...
shapiro.test(log.ver)
    ## p-value = 0.08386
    ## Barely non-significant...I want a bigger p-value
ks.test(log.ver, "pnorm", mean=mean(log.ver), sd=sd(log.ver))
    ## p-value = 0.5135
    ## This is A LOT better
############ The histogram looks great, & both shapiro & ks come out not significant
############ Although shapiro is close-ish to the edge, I think it's okay based on the histogram




####### Repeat for phy.Ver.water #######
phy.Ver.water.otu <- as.numeric(otu_table(phy.Ver.water))
hist(phy.Ver.water.otu, 
  breaks = seq(0, .5, by = 0.025), 
  xlab = "Relative Abundance", 
  main = "Original Histogram"
)
    ## NOT NORMAL
    ## SKEWED RIGHT
qqnorm(phy.Ver.water.otu)
qqline(phy.Ver.water.otu)
    ## NOT NORMAL

# Test for normality
shapiro.test(phy.Ver.water.otu)
    ## DEF not normal (p-value = 0)
ks.test(phy.Ver.water.otu, "pnorm", mean = mean(phy.Ver.water.otu), sd = sd(phy.Ver.water.otu))
    # NOT NORMAL (p-value = 0.0275)

##### Log Transformation #####
log.ver.water <- log(phy.Ver.water.otu)
hist(log.ver.water, breaks = 18, main = "Log-Transformed Histogram", xlab = "Log(Relative Abundance)")
    ## LOOKS BEAUTIFUL!
qqnorm(log.ver.water)
qqline(log.ver.water)
    ## Looks slightly better...
shapiro.test(log.ver.water)
    ## p-value = 0.05037
    ## Barely non-significant...I want a bigger p-value
ks.test(log.ver.water, "pnorm", mean = mean(log.ver.water), sd = sd(log.ver.water))
    ## p-value = 0.5383
    ## This is A LOT better




################ Import normal data in phy.Ver phyloseq object ################
phy.Ver.otu <- data.frame(otu_table(phy.Ver))
phy.Ver.otu[1, ] <- log.ver

phy.Ver.water.otu <- data.frame(otu_table(phy.Ver.water))
phy.Ver.water.otu[1, ] <- log.ver.water

################# THIS IS THE VERRUCO PHYLUM PHYLOSEQ OBJECT YOU'LL USE IN THE FUTURE #################
otu <- otu_table(phy.Ver.otu, taxa_are_rows = TRUE)
tax <- tax_table(phy.Ver)
samp <- sample_data(phy.Ver)
normal.Ver <- merge_phyloseq(tax, otu, samp)


```


### Box-And-Whisker Plots
```{r}
######## YOU'RE USING THE PHY.VER.OTU DATAFRAME WITH THE NORMAL DATA ########
tphy.Ver.otu <- t(phy.Ver.otu)
phy.Ver.samp.norm <- data.frame(sample_data(phy.Ver))
phy.Ver.samp.norm$Relative_Abundance <- tphy.Ver.otu[,1]
phy.Ver.samp.norm$Group <- ordered(phy.Ver.samp.norm$Group, levels=c("Laurentian","Estuary","Inland"))
phy.Ver.samp.norm$Lake <- ordered(phy.Ver.samp.norm$Lake, levels=c("Michigan", "Muskegon", "BigSeven", "Bishop", "Bruin", "Cedar", "Halfmoon", "Heron", "Independence", "Lobdell", "North", "Sand", "Whitmore", "Woodland"))
phy.Ver.samp.norm$Fraction <- ordered(phy.Ver.samp.norm$Fraction, levels = c("Particle", "Free", "Sediment"))
phy.Ver.samp.norm$Depth <- ordered(phy.Ver.samp.norm$Depth, levels = c("Top", "Bottom", "Sediment"))

phy.Ver.otu.box <- data.frame(otu_table(phy.Ver))
tphy.Ver.box <- t(phy.Ver.otu.box)
phy.Ver.samp <- data.frame(sample_data(phy.Ver))
phy.Ver.samp$Relative_Abundance <- tphy.Ver.box[,1]
phy.Ver.samp$Group <- ordered(phy.Ver.samp$Group, levels=c("Laurentian","Estuary","Inland"))
phy.Ver.samp$Lake <- ordered(phy.Ver.samp$Lake, levels=c("Michigan", "Muskegon", "BigSeven", "Bishop", "Bruin", "Cedar", "Halfmoon", "Heron", "Independence", "Lobdell", "North", "Sand", "Whitmore", "Woodland"))
phy.Ver.samp$Fraction <- ordered(phy.Ver.samp$Fraction, levels = c("Particle", "Free", "Sediment"))
phy.Ver.samp$Depth <- ordered(phy.Ver.samp$Depth, levels = c("Top", "Bottom", "Sediment"))



################### BOXPLOT BY GROUP & FRACTION ###################
tiff("boxplot.tiff", width = 7, height = 5, units = "in", res = 500)
boxplot(phy.Ver.samp$Relative_Abundance ~ phy.Ver.samp$Group + phy.Ver.samp$Fraction, xlab = "Sample", ylab = "Relative Abundance", main = "Verrucomicrobia Abundance", names = rep("",9))
dev.off()

group.box <- boxplot(phy.Ver.samp$Relative_Abundance ~ phy.Ver.samp$Group, xlab = "Group", ylab = "Relative Abundance")
pairwise.t.test(x = phy.Ver.samp.norm$Relative_Abundance, g=phy.Ver.samp.norm$Group, p.adjust="bonferroni")
    ## SIGNIFICANT btwn Estuary/Laurentian & Inland/Laurentian
    ## NOT SIGNIFICANT btwn Estuary & Inland

lake.box <- boxplot(phy.Ver.samp$Relative_Abundance ~ phy.Ver.samp$Lake, data = phy.Ver.samp, xlab = "Lake Type", ylab = "Relative Abundance", main = "Lake Type", ylim = c(0,0.45))
anova(lm(phy.Ver.samp$Relative_Abundance ~ phy.Ver.samp$Lake))
    ## Significant
pairwise.t.test(x = phy.Ver.samp.norm$Relative_Abundance, g=phy.Ver.samp.norm$Lake, p.adjust="bonferroni")
    ## SIGNIFICANT btwn Michigan/Muskegon, Michigan/Bruin, Michigan/Heron, Michigan/Independence, Michigan/North, Michigan/Sand, Michigan/Whitmore;; Michigan/Lobdell is on the cusp
    ## SIGNIFICANT btwn Muskegon/Michigan, Muskegon/North
    ## SIGNIFICANT btwn North & Michigan, Cedar

fraction.box <- boxplot(phy.Ver.samp$Relative_Abundance ~ phy.Ver.samp$Fraction, xlab = "Fraction", ylab = "Relative Abundance", main = "Fraction")
pairwise.t.test(x = phy.Ver.samp.norm$Relative_Abundance, g=phy.Ver.samp.norm$Fraction, p.adjust="bonferroni")
    ## SIGNIFICANT between Sed/Part & Sed/Free
    ## NOT SIGNIFICANT btwn Part & Free

depth.box <- boxplot(phy.Ver.samp$Relative_Abundance ~ phy.Ver.samp$Depth, xlab = "Depth", ylab = "Relative Abundance", main = "Depth")
pairwise.t.test(x = phy.Ver.samp.norm$Relative_Abundance, g=phy.Ver.samp.norm$Depth, p.adjust="bonferroni")
    ## SIGNIFICANT between Sed/Top & Sed/Bottom
    ## NOT SIGNIFICANT btwn Top & Bottom

date.box <- boxplot(phy.Ver.samp$Relative_Abundance ~ phy.Ver.samp$Season, xlab = "Season", ylab = "Relative Abundance", main = "Season")
pairwise.t.test(x = phy.Ver.samp.norm$Relative_Abundance, g=phy.Ver.samp.norm$Season, p.adjust="bonferroni")
    ## NOT SIGNIFICANT (p-value=1)

origin.box <- boxplot(phy.Ver.samp$Relative_Abundance ~ phy.Ver.samp$Origin, xlab = "Season", ylab = "Relative Abundance", main = "Season")
pairwise.t.test(x = phy.Ver.samp.norm$Relative_Abundance, g=phy.Ver.samp.norm$Origin, p.adjust="bonferroni")
    ## SIGNIFICANT (p-value = 0.001)


############################## Just water column samples (NO SEDIMENT) ##############################
######## YOU'RE USING THE PHY.VER.WATER.OTU DATAFRAME WITH THE NORMAL DATA ########
phy.Ver.water.otu <- data.frame(otu_table(phy.Ver.water))
tphy.Ver.water.otu <- t(phy.Ver.water.otu)
phy.Ver.water.samp <- data.frame(sample_data(phy.Ver.water))
phy.Ver.water.samp$Relative_Abundance <- tphy.Ver.water.otu[,1]
phy.Ver.water.samp$Group <- ordered(phy.Ver.water.samp$Group, levels=c("Laurentian","Estuary","Inland"))
phy.Ver.water.samp$Lake <- ordered(phy.Ver.water.samp$Lake, levels=c("Michigan", "Muskegon", "BigSeven", "Bishop", "Bruin", "Cedar", "Halfmoon", "Heron", "Independence", "Lobdell", "North", "Sand", "Whitmore", "Woodland"))
phy.Ver.water.samp$Fraction <- ordered(phy.Ver.water.samp$Fraction, levels = c("Particle", "Free"))
phy.Ver.water.samp$Depth <- ordered(phy.Ver.water.samp$Depth, levels = c("Top", "Bottom"))

### By Group ###
boxplot(phy.Ver.water.samp$Relative_Abundance ~ phy.Ver.water.samp$Group, xlab = "Lake Type", ylab = "Relative Abundance", main = "Lake Type")
pairwise.t.test(x = phy.Ver.water.samp$Relative_Abundance, g=phy.Ver.water.samp$Group, p.adjust="bonferroni")
    ## SIGNIFICANT btwn Estuary/Laurentian & Inland/Laurentian
    ## NOT SIGNIFICANT btwn Estuary & Inland

### By Lake ###
boxplot(phy.Ver.water.samp$Relative_Abundance ~ phy.Ver.water.samp$Lake, data = phy.Ver.samp, xlab = "Lake Type", ylab = "Relative Abundance", main = "Lake Type", ylim = c(0,0.45))
anova(lm(phy.Ver.water.samp$Relative_Abundance ~ phy.Ver.water.samp$Lake))
    ## Significant
pairwise.t.test(x = phy.Ver.water.samp$Relative_Abundance, g=phy.Ver.water.samp$Lake, p.adjust="bonferroni")
    ## SIGNIFICANT btwn Michigan/Muskegon, Michigan/Bruin, Michigan/Heron, Michigan/Independence, Michigan/North, Michigan/Sand, Michigan/Whitmore;; Michigan/Lobdell is on the cusp
    ## SIGNIFICANT btwn Muskegon/Michigan
    ## SIGNIFICANT btwn North & Michigan, BigSeven, Bishop, Bruin, Cedar

### By Fraction ###
boxplot(phy.Ver.water.samp$Relative_Abundance ~ phy.Ver.water.samp$Fraction, xlab = "Fraction", ylab = "Relative Abundance", main = "Fraction")
pairwise.t.test(x = phy.Ver.water.samp$Relative_Abundance, g=phy.Ver.water.samp$Fraction, p.adjust="bonferroni")
    ## NOT SIGNIFICANT btwn Part & Free

### By Depth ###
boxplot(phy.Ver.water.samp$Relative_Abundance ~ phy.Ver.water.samp$Depth, xlab = "Depth", ylab = "Relative Abundance", main = "Depth")
pairwise.t.test(x = phy.Ver.water.samp$Relative_Abundance, g=phy.Ver.water.samp$Depth, p.adjust="bonferroni")
    ## NOT SIGNIFICANT btwn Top & Bottom


################### REMOVING SED DOESN'T HAVE AN EFFECT ON SIG BY GROUP OR LAKE ###################


```

### Time to transform your ENTIRE VERRUCO COMMUNITY DATA to become normal
```{r}
# Transforms each merged phylum count to rel abun
Ver.rel = transform_sample_counts(Ver, function(x){x/sum(x)})

# If a phylum has <1% rel abun, change that to 0%
otu_table(Ver.rel)[otu_table(Ver.rel)<.01] <- 0

# Remove anything with 0% rel abun
Ver.rel = prune_taxa(taxa_sums(Ver.rel)>0,Ver.rel)

# Create rank abundance of OTUs
barplot(sort(taxa_sums(Ver.rel),TRUE)[1:20]/nsamples(Ver.rel),las=2,cex.axis=.7)
    ## 1 = OPB35_soil_group
    ## 2 = OPB35_soil_group
    ## 3 = Opitutae - vadinHA64
    ## 4 = Spartobacteria - Chthoniobacterales - FukuN18_freshwater_group
    ## 5 = Verrucomicrobiae - Verrucomicrobiales - Verrucomicrobiaceae

Ver.otu <- as.numeric(otu_table(Ver.rel))
hist(Ver.otu)
    ## So skewed that I can't even get a legit histogram from it
qqnorm(Ver.otu)
qqline(Ver.otu)
    ## Looks exponentially distributed

# Test for normality
shapiro.test(Ver.otu)
    ## Too many samples
ks.test(Ver.otu, "pnorm", mean=mean(Ver.otu), sd=sd(Ver.otu))
    # p-value = 0
    # Not normal
ks.test(Ver.otu, "pexp")
    ## p-value = 9
    ## not exponentially distributed
Ver.otu <- Ver.otu + 1

#### Log Transformation ####
Ver.log <- log(Ver.otu)
hist(Ver.log)
    ## Still not normal
    ## Skewed to the right
qqnorm(Ver.log)
qqline(Ver.log)
ks.test(Ver.log, "pnorm", mean=mean(Ver.otu), sd=sd(Ver.otu))
    ## p=value = 0
    ## Not normal

#################### Verruco Intra-Phyla Rel Abun is NOT NORMAL ####################

```

### NMDS
```{r}
nowinOTU <- otu_table(Ver.rel)
norm.bray <- vegdist(nowinOTU, method = "bray", binary = FALSE)
    ## Calculates Bray-Curtis distances
nowinOTU.df <- data.frame(otu_table(Ver.rel))
norm.soren <- vegdist(nowinOTU.df, method = "bray", binary = TRUE)
    ## Calculates Sorensen Indicies


################### Start on the NMDS (Bray-Curtis) ###################
nmds.bray <- metaMDS(t(nowinOTU), distance="bray")
    ## NMDS from vegan package
    ## stress - 0.2230533
nmds.bray <- data.frame(nmds.bray$points)
nmds.bray$Names <- row.names(nmds.bray)

### Creating dataframe
nowinSamp <- data.frame(sample_data(Ver.rel))
nmds.bray$Group <- nowinSamp$Group
nmds.bray$Lake <- nowinSamp$Lake
nmds.bray$Date <- nowinSamp$Date
nmds.bray$Site <- nowinSamp$Site
nmds.bray$Depth <- nowinSamp$Depth
nmds.bray$Fraction <- nowinSamp$Fraction
nmds.bray$Season <- nowinSamp$Season

### Order factors
nmds.bray$Group<- ordered(nmds.bray$Group, levels = c("Laurentian", "Estuary", "Inland"))
nmds.bray$Lake<- ordered(nmds.bray$Lake, levels = c("Michigan", "Muskegon", "BigSeven", "Bishop", "Bruin", "Cedar", "Halfmoon", "Heron", "Independence", "Lobdell", "North", "Sand", "Whitmore", "Woodland"))
nmds.bray$Fraction<- ordered(nmds.bray$Fraction, levels = c("Particle", "Free", "Sediment"))
nmds.bray$Depth<- ordered(nmds.bray$Depth, levels = c("Top", "DCM", "Bottom", "Sediment"))
nmds.bray$Season<- ordered(nmds.bray$Season, levels = c("Spring", "Summer", "Fall"))






####### GROUP #######
tiff("nmds.group.depth.tiff", width = 6.5, height = 5, units = "in", res = 500)
ggplot(nmds.bray, aes(MDS1*10, MDS2*10, color=Group, shape = Depth)) +
  xlab("NMDS1") + ylab("NMDS2") + ggtitle("Bray-Curtis Dissimilarity") +
  geom_point(size=2,alpha = 1) + theme_bw() +
  scale_color_manual(name = "Group", breaks = c("Laurentian","Estuary","Inland"),
                     labels = c("Laurentian","Estuary","Inland"),
                     values = c("indianred1","green3","mediumpurple2")) +
  scale_shape_manual(name = "Depth", breaks = c("Top", "DCM", "Bottom", "Sediment"),
                     labels = c("Top", "DCM", "Bottom", "Sediment"),
                     values = c(17, 5, 16, 4)) +
  theme(axis.title.x = element_text(size=16, face="bold"),
        axis.text.x = element_text(angle=50, colour="black", vjust=1, hjust=1, size=14),
        axis.text.y = element_text(colour="black", size=14),
        plot.title = element_text(size=18),
        legend.title = element_text(size=14),
        legend.text = element_text(size = 13),
        legend.position = "right") +
  guides(fill=guide_legend(order = 1, keywidth = 1, keyheight = 1), color = guide_legend(order=3)) +
  xlab("NMDS1") +
  ylab("NMDS2") +
  ggtitle("Bray-Curtis Dissimilarity")
dev.off()






### Color by Depth, Shape by Group;; I don't really like this plot very much
tiff("nmds.colordepth.shapegroup.tiff", width = 6.5, height = 5, units = "in", res = 500)
ggplot(nmds.bray, aes(MDS1*10, MDS2*10, color=Depth, shape = Group)) +
  xlab("NMDS1") + ylab("NMDS2") + ggtitle("Bray-Curtis Dissimilarity") +
  geom_point(size=2,alpha = 1) + theme_bw() +
  scale_shape_manual(name = "Group", breaks = c("Laurentian","Estuary","Inland"),
                     labels = c("Laurentian","Estuary","Inland"),
                     values = c(5,16,4)) +
  scale_color_manual(name = "Depth", breaks = c("Top", "DCM", "Bottom", "Sediment"),
                     labels = c("Top", "DCM", "Bottom", "Sediment"),
                     values = c("indianred1","green3","mediumpurple2", "skyblue")) +
  theme(axis.title.x = element_text(size=16, face="bold"),
        axis.text.x = element_text(angle=50, colour="black", vjust=1, hjust=1, size=14),
        axis.text.y = element_text(colour="black", size=14),
        plot.title = element_text(size=18),
        legend.title = element_text(size=14),
        legend.text = element_text(size = 13),
        legend.position = "right") +
  guides(fill=guide_legend(order = 1, keywidth = 1, keyheight = 1), color = guide_legend(order=3)) +
  xlab("NMDS1") +
  ylab("NMDS2") +
  ggtitle("Bray-Curtis Dissimilarity")
dev.off()




### Color by Fraction, Shape by Group;; This plot isn't half bad
tiff("nmds.colorfrac.shapegroup.tiff", width = 6.5, height = 5, units = "in", res = 500)
ggplot(nmds.bray, aes(MDS1*10, MDS2*10, color=Fraction, shape = Group)) +
  xlab("NMDS1") + ylab("NMDS2") + ggtitle("Bray-Curtis Dissimilarity") +
  geom_point(size=2,alpha = 1) + theme_bw() +
  scale_shape_manual(name = "Group", breaks = c("Laurentian","Estuary","Inland"),
                     labels = c("Laurentian","Estuary","Inland"),
                     values = c(5,16,4)) +
  scale_color_manual(name = "Fraction", breaks = c("Particle","Free","Sediment"),
                     labels = c("Particle","Free","Sediment"),
                     values = c("indianred1","deepskyblue","mediumpurple2")) +
  theme(axis.title.x = element_text(size=16, face="bold"),
        axis.text.x = element_text(angle=50, colour="black", vjust=1, hjust=1, size=14),
        axis.text.y = element_text(colour="black", size=14),
        plot.title = element_text(size=18),
        legend.title = element_text(size=14),
        legend.text = element_text(size = 13),
        legend.position = "right") +
  guides(fill=guide_legend(order = 1, keywidth = 1, keyheight = 1), color = guide_legend(order=3)) +
  xlab("NMDS1") +
  ylab("NMDS2") +
  ggtitle("Bray-Curtis Dissimilarity")
dev.off()



### Color by Season, Shape by Group;; This plot isn't half bad
tiff("nmds.colorseason.shapegroup.tiff", width = 6.5, height = 5, units = "in", res = 500)
ggplot(nmds.bray, aes(MDS1*10, MDS2*10, color=Season, shape = Group)) +
  xlab("NMDS1") + ylab("NMDS2") + ggtitle("Bray-Curtis Dissimilarity") +
  geom_point(size=2,alpha = 1) + theme_bw() +
  scale_shape_manual(name = "Group", breaks = c("Laurentian","Estuary","Inland"),
                     labels = c("Laurentian","Estuary","Inland"),
                     values = c(5,16,4)) +
  scale_color_manual(name = "Season", breaks = c("Spring","Summer","Fall"),
                     labels = c("Spring","Summer","Fall"),
                     values = c("indianred1","deepskyblue","mediumpurple2")) +
  theme(axis.title.x = element_text(size=16, face="bold"),
        axis.text.x = element_text(angle=50, colour="black", vjust=1, hjust=1, size=14),
        axis.text.y = element_text(colour="black", size=14),
        plot.title = element_text(size=18),
        legend.title = element_text(size=14),
        legend.text = element_text(size = 13),
        legend.position = "right") +
  guides(fill=guide_legend(order = 1, keywidth = 1, keyheight = 1), color = guide_legend(order=3)) +
  xlab("NMDS1") +
  ylab("NMDS2") +
  ggtitle("Bray-Curtis Dissimilarity")
dev.off()



### Color by Group, Shape by Season, Size by Fraction
ggplot(nmds.bray, aes(MDS1*10, MDS2*10, color=Group, shape = Season, size = Fraction)) +
  xlab("NMDS1") + ylab("NMDS2") + ggtitle("Bray-Curtis Dissimilarity") +
  geom_point(alpha = 1) + theme_bw() +
  scale_color_manual(name = "Lake Type", breaks = c("Laurentian","Estuary","Inland"),
                     labels = c("Laurentian","Estuary","Inland"),
                     values = c("indianred1","green3","mediumpurple2")) +
  scale_shape_manual(name = "Season", breaks = c("Spring", "Summer", "Fall"),
                     labels = c("Spring", "Summer", "Fall"),
                     values = c(4, 16, 17)) +
  scale_size_manual(name = "Fraction", breaks = c("Particle","Free", "Sediment"),
                    labels = c("Particle","Free","Sediment"),
                    values = c(4, 2, 1)) +
  theme(axis.title.x = element_text(size=16, face="bold"),
        axis.text.x = element_text(angle=50, colour="black", vjust=1, hjust=1, size=14),
        axis.text.y = element_text(colour="black", size=14),
        plot.title = element_text(size=18),
        legend.title = element_text(size=14),
        legend.text = element_text(size = 13),
        legend.position = "right") +
  guides(fill=guide_legend(order = 1, keywidth = 1, keyheight = 1), color = guide_legend(order=3)) +
  xlab("NMDS1") +
  ylab("NMDS2") +
  ggtitle("Bray-Curtis Dissimilarity")

### Facet by Group, Color by Fraction, Shape by Season
tiff("nmds.facet.tiff", width = 6.5, height = 5, units = "in", res = 500)
ggplot(nmds.bray, aes(MDS1*10, MDS2*10, color=Fraction, shape = Season, size = Fraction)) +
  xlab("NMDS1") + ylab("NMDS2") + ggtitle("Bray-Curtis Dissimilarity") +
  geom_point(size = 2, alpha = 1) + theme_bw() +
  facet_grid(.~Group) +
  scale_color_manual(name = "Fraction", breaks = c("Particle","Free","Sediment"),
                     labels = c("Particle","Free","Sediment"),
                     values = c("blue3","gold", "tan3")) +
  scale_shape_manual(name = "Season", breaks = c("Spring", "Summer", "Fall"),
                     labels = c("Spring", "Summer", "Fall"),
                     values = c(4, 16, 17)) +
  theme(axis.title.x = element_text(size=16, face="bold"),
        axis.text.x = element_text(angle=50, colour="black", vjust=1, hjust=1, size=14),
        axis.text.y = element_text(colour="black", size=14),
        plot.title = element_text(size=18),
        legend.title = element_text(size=14),
        legend.text = element_text(size = 13),
        legend.position = "right") +
  guides(fill=guide_legend(order = 1, keywidth = 1, keyheight = 1), color = guide_legend(order=3)) +
  xlab("NMDS1") +
  ylab("NMDS2") +
  ggtitle("Bray-Curtis Dissimilarity")
dev.off()

### Facet by Group, Color by Fraction, Shape by Season
ggplot(nmds.bray, aes(MDS1*10, MDS2*10, color=Fraction, shape = Season, size = Depth)) +
  xlab("NMDS1") + ylab("NMDS2") + ggtitle("Bray-Curtis Dissimilarity") +
  geom_point(size = 2, alpha = 1) + theme_bw() +
  facet_grid(.~Group) +
  scale_color_manual(name = "Fraction", breaks = c("Particle","Free","Sediment"),
                     labels = c("Particle","Free","Sediment"),
                     values = c("blue3","gold", "tan3")) +
  scale_shape_manual(name = "Season", breaks = c("Spring", "Summer", "Fall"),
                     labels = c("Spring", "Summer", "Fall"),
                     values = c(4, 16, 17)) +
  scale_size_manual(name = "Depth", breaks = c("Top","DCM","Bottom","Sediment"),
                    labels = c("Top","DCM","Bottom","Sediment"),
                    values = c(9, 7, 5, 3)) + 
  theme(axis.title.x = element_text(size=16, face="bold"),
        axis.text.x = element_text(angle=50, colour="black", vjust=1, hjust=1, size=14),
        axis.text.y = element_text(colour="black", size=14),
        plot.title = element_text(size=18),
        legend.title = element_text(size=14),
        legend.text = element_text(size = 13),
        legend.position = "right") +
  guides(fill=guide_legend(order = 1, keywidth = 1, keyheight = 1), color = guide_legend(order=3)) +
  xlab("NMDS1") +
  ylab("NMDS2") +
  ggtitle("Bray-Curtis Dissimilarity")








################################ SORENSEN  ################################
### Bray-Curtis is weighted (abundance matters)
### Sorensen is unweighted (abundance does not matter)

plot(hclust(norm.soren), main = "Sorensen Distance")
    ## lolwutisthis

soren.pcoa <- pcoa(norm.soren)
soren.pcoa2 <- soren.pcoa$vectors
soren.pcoa3 <- data.frame(soren.pcoa2[, 1:3])
soren.pcoa3$Names <- row.names(soren.pcoa3)
soren.pcoa3$Group <- nowinSamp$Group
soren.pcoa3$Lake <- nowinSamp$Lake
soren.pcoa3$Date <- nowinSamp$Date
soren.pcoa3$Site <- nowinSamp$Site
soren.pcoa3$Depth <- nowinSamp$Depth
soren.pcoa3$Fraction <- nowinSamp$Fraction
soren.pcoa3$Season <- nowinSamp$Season



#soren_pcoa <- pcoa(norm.soren)
#soren_pcoa2 <- soren_pcoa$vectors
#soren_pcoa3 <- data.frame(soren_pcoa2[, 1:3])
#soren_pcoa3$names <- row.names(soren_pcoa3)
soren_pcoa4 <- makeCategories_dups(soren_pcoa3)
soren_pcoa4$quadrant <- factor(soren_pcoa4$quadrant,levels = c("Free Epilimnion", "Free Mixed",  "Free Hypolimnion", "Particle Epilimnion", "Particle Mixed", "Particle Hypolimnion"))
### Let's extract the values of each axis for the pcoa
soren_values <- soren_pcoa$values
soren_rel_eigens <- soren_values$Relative_eig
soren_rel_eigen1 <- soren_rel_eigens[1]
soren_rel_eigen1_percent <- round(soren_rel_eigen1 * 100, digits = 1)
soren_rel_eigen2 <- soren_rel_eigens[2]
soren_rel_eigen2_percent <- round(soren_rel_eigen2 * 100, digits = 1)
soren_axis1 <- paste("PCoA1:",soren_rel_eigen1_percent,"%")
soren_axis2 <- paste("PCoA2:",soren_rel_eigen2_percent,"%")

pcoa_soren <- ggplot(soren_pcoa4, aes(Axis.1 * -1, Axis.2 * -1, color = quadrant, shape = trophicstate)) +
  xlab(soren_axis1) + ylab(soren_axis2) + #ggtitle("Bray-Curtis: Trophic State") +
  geom_point(size= 6, alpha=0.9) + theme_bw() + #ylim(1, -1) + xlim(1, -1) +
  scale_color_manual(name = "Habitat", breaks=c("Free Epilimnion", "Free Mixed",  "Free Hypolimnion", "Particle Epilimnion", "Particle Mixed", "Particle Hypolimnion"),
                     labels = c("Free-Living Epilimnion", "Free-Living Mixed",  "Free-Living Hypolimnion", "Particle-Associated Epilimnion", "Particle-Associated Mixed", "Particle-Associated Hypolimnion"), 
                     values = c("purple3", "mediumblue", "darkgreen", "orchid1", "deepskyblue", "green")) +
  scale_shape_manual(name = "Trophic State", breaks = c("Eutrophic", "Mesotrophic", "Oligotrophic", "Mixed"), 
                     labels = c("Eutrophic", "Mesotrophic", "Oligotrophic", "Mixed"),
                     values = c(15, 19, 17)) +
  theme(axis.text.x = element_text(colour="black", vjust=0.5, size=14), 
        axis.text.y = element_text(colour="black", vjust=0.5, size=14),
        axis.title.x = element_text(face="bold", size=16),
        axis.title.y = element_text(face="bold", size=16),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size = 12),
        ###LEGEND TOP RIGHT CORNER
        legend.position = "right"); pcoa_soren




###################################### SORENSEN NMDS ######################################
nmds.soren <- metaMDS(nowinOTU, distance="bray", binary=T)






##### Below is Marian's code of an NMDS of Sorensen Index #####
nmds_soren <- metaMDS(nowinOTU, distance="bray", binary = TRUE)
nmds_soren <- data.frame(nmds_soren$points) #http://strata.uga.edu/software/pdf/mdsTutorial.pdf
nmds_soren$names<-row.names(nmds_soren) #new names column
nmds_soren <- makeCategories_dups(nmds_soren) #will add our categorical information:  lakenames, limnion, filter, quadrant and trophicstate
nmds_soren$ProdLevel <- as.character(nmds_soren$trophicstate)
nmds_soren$ProdLevel[nmds_soren$trophicstate == "Eutrophic"] <- "Productive"
nmds_soren$ProdLevel[nmds_soren$trophicstate == "Mesotrophic"] <- "Productive"
nmds_soren$ProdLevel[nmds_soren$trophicstate == "Oligotrophic"] <- "Unproductive"
nmds_soren$quadrant <- factor(nmds_soren$quadrant,levels = c("Free Epilimnion", "Free Mixed",  "Free Hypolimnion", "Particle Epilimnion", "Particle Mixed", "Particle Hypolimnion"))

nmds_soren_quad <- ggplot(nmds_soren, aes(MDS1, MDS2, color = quadrant, shape = ProdLevel)) +
  xlab("NMDS1") + ylab("NMDS2") + ggtitle("SÃ¸rensen Dissimilarity") +
  geom_point(size= 6, alpha=0.9) + theme_bw() +   geom_point(colour="white", size = 2) +
  annotate("text", label = "A", x = (min(nmds_soren$MDS1) + 0.05), y = (max(nmds_soren$MDS2) -0.02), face = "bold",size = 10, colour = "black") +
  annotate("text", label = "Stress = 0.14", x = (max(nmds_soren$MDS1) -0.18), y = (max(nmds_soren$MDS2) -0.01), size = 6, colour = "black") +
  scale_color_manual(name = "Habitat", breaks=c("Free Epilimnion", "Free Mixed",  "Free Hypolimnion", "Particle Epilimnion", "Particle Mixed", "Particle Hypolimnion"),
                     labels = c("Free-Living Epilimnion", "Free-Living Mixed",  "Free-Living Hypolimnion", "Particle-Associated Epilimnion", "Particle-Associated Mixed", "Particle-Associated Hypolimnion"), 
                     values = c("darkgreen", "mediumblue", "purple3", "green", "deepskyblue", "orchid1")) +
  scale_shape_manual(name = "Nutrient Level", breaks = c("Productive", "Unproductive"), 
                     labels = c("High", "Low"),
                     values = c(15, 17)) +
  guides(shape = guide_legend(order=1), color = guide_legend(order=2)) +
  theme(axis.text.x = element_text(colour="black", vjust=0.5, size=14), 
        axis.text.y = element_text(colour="black", vjust=0.5, size=14),
        axis.title.x = element_text(face="bold", size=16),
        axis.title.y = element_text(face="bold", size=16),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size = 12),
        plot.title = element_text(size = 16, face="bold"),
        ###LEGEND TOP RIGHT CORNER
        legend.position = "none");  nmds_soren_quad




############################ PREPARING FOR ADONIS ############################
test.otu <- data.frame(otu_table(Ver.rel))
test.otu <- t(test.otu)
test.bray <- vegdist(test.otu, method = "bray")
    ## ROWS = SAMPLES
    ## COLS = OTUs
    ## IF IT'S NOT SET UP LIKE THIS, IT WON'T WORK!
test.sample <- data.frame(sample_data(Ver.rel))



################################# ADONIS ADONIS ADONIS ADONIS ADONIS ################################# 

####################### Group #######################
adonis.group <- adonis(test.bray ~ Group, test.sample)
    ## SIGNIFICANT (p-value = 0.001)
    ## R2 = 0.11273
beta.tax = betadisper(test.bray, test.sample$Group)
p <- permutest(beta.tax)
p$tab
    ## Not significant (p-value = 0.911)
    ## F = 0.0925504

### Laurentian & Estuary ###
le.phy <- subset_samples(Ver.rel, Group != "Inland")
le.otu <- t(data.frame(otu_table(le.phy)))
le.bray <- vegdist(le.otu, method = "bray")
le.samp <- data.frame(sample_data(le.phy))
adonis.group <- adonis(le.bray ~ Group, le.samp)
    ## LAURENTIAN & ESTUARY ARE SIGNIFICANT (p-value = 0.001)
    ## R2 = 0.11037
beta.tax <- betadisper(le.bray, le.samp$Group)
p <- permutest(beta.tax)
p$tab
    ## Not significant (p-value = 0.756)
    ## F = 0.1158866

### Laurentian & Inland ###
li.phy <- subset_samples(Ver.rel, Group != "Estuary")
li.otu <- t(data.frame(otu_table(li.phy)))
li.bray <- vegdist(li.otu, method = "bray")
li.samp <- data.frame(sample_data(li.phy))
adonis.group <- adonis(li.bray ~ Group, li.samp)
    ## LAURENTIAN & ESTUARY ARE SIGNIFICANT (p-value = 0.001)
    ## R2 = 0.08129
beta.tax = betadisper(li.bray, li.samp$Group)
p=permutest(beta.tax)
p$tab
    ## Not significant (p-value = 0.861)
    ## F = 0.03344

### Laurentian & Inland ###
li.phy <- subset_samples(Ver.rel, Group != "Estuary")
li.otu <- t(data.frame(otu_table(li.phy)))
li.bray <- vegdist(li.otu, method = "bray")
li.samp <- data.frame(sample_data(li.phy))
adonis.group <- adonis(li.bray ~ Group, li.samp)
    ## LAURENTIAN & INLAND ARE SIGNIFICANT (p-value = 0.001)
    ## R2 = 0.08129
beta.tax = betadisper(li.bray, li.samp$Group)
p=permutest(beta.tax)
p$tab
    ## Not significant (p-value = 0.861)
    ## F = 0.03344

### Estuary & Inland ###
ei.phy <- subset_samples(Ver.rel, Group != "Laurentian")
ei.otu <- t(data.frame(otu_table(ei.phy)))
ei.bray <- vegdist(ei.otu, method = "bray")
ei.samp <- data.frame(sample_data(ei.phy))
adonis.group <- adonis(ei.bray ~ Group, ei.samp)
    ## ESTUARY AND INLAND ARE SIGNIFICANT (p-value = 0.001)
    ## R2 = 0.07519
beta.tax = betadisper(ei.bray, ei.samp$Group)
p=permutest(beta.tax)
p$tab
    ## Not significant (p-value = 0.733)
    ## F = 0.1042774



####################### Lake #######################
adonis.lake <- adonis(test.bray ~ Lake, test.sample)
    ## SIGNIFICANT (p-value = 0.001)
    ## R2 = 0.25706
beta.tax = betadisper(test.bray, test.sample$Lake)
p=permutest(beta.tax)
p$tab
    ## SIGNIFICANT (p-value = 0.001)
    ## F = 3.319597

### All Inland Lakes ###
in.phy <- subset_samples(Ver.rel, Group != "Laurentian")
in.phy <- subset_samples(in.phy, Group != "Estuary")
in.otu <- t(data.frame(otu_table(in.phy)))
in.bray <- vegdist(in.otu, method = "bray")
in.samp <- data.frame(sample_data(in.phy))
adonis.lake <- adonis(in.bray ~ Lake, in.samp)
    ## ALL INLAND LAKES ARE SIGNIFICANT (p-value = 0.001)
    ## R2 = 0.30286
beta.tax = betadisper(in.bray, in.samp$Lake)
p=permutest(beta.tax)
p$tab
    ## Not significant (p-value = 0.186)
    ## F = 1.366156

####################### Fraction #######################
adonis.fraction <- adonis(test.bray ~ Fraction, test.sample)
    ## SIGNIFICANT (p-value = 0.001)
    ## R2 = 0.16876
beta.tax = betadisper(test.bray, test.sample$Fraction)
p=permutest(beta.tax)
p$tab
    ## SIGNIFICANT (p-value = 0.001)
    ## F = 27.38858

### Particle vs. Free ###
pf.phy <- subset_samples(Ver.rel, Fraction != "Sediment")
pf.otu <- t(data.frame(otu_table(pf.phy)))
pf.bray <- vegdist(pf.otu, method = "bray")
pf.samp <- data.frame(sample_data(pf.phy))
adonis.fraction <- adonis(pf.bray ~ Fraction, pf.samp)
    ## PARTICLE VS. FREE IS SIGNIFICANT (p-value = 0.001)
    ## R2 = 0.09636
beta.tax = betadisper(pf.bray, pf.samp$Fraction)
p=permutest(beta.tax)
p$tab
    ## SIGNIFICANT (p-value = 0.001)
    ## F = 17.77422

### Particle vs. Sediment ###
ps.phy <- subset_samples(Ver.rel, Fraction != "Free")
ps.otu <- t(data.frame(otu_table(ps.phy)))
ps.bray <- vegdist(ps.otu, method = "bray")
ps.samp <- data.frame(sample_data(ps.phy))
adonis.fraction <- adonis(ps.bray ~ Fraction, ps.samp)
    ## PARTICLE VS. SEDIMENT IS SIGNIFICANT (p-value = 0.001)
    ## R2 = 0.14117
beta.tax <- betadisper(ps.bray, ps.samp$Fraction)
p <- permutest(beta.tax)
p$tab
    ## SIGNIFICANT (p-value = 0.001)
    ## F = 52.04351

### Free vs. Sediment ###
fs.phy <- subset_samples(Ver.rel, Fraction != "Particle")
fs.otu <- t(data.frame(otu_table(fs.phy)))
fs.bray <- vegdist(fs.otu, method = "bray")
fs.samp <- data.frame(sample_data(fs.phy))
adonis.fraction <- adonis(fs.bray ~ Fraction, fs.samp)
    ## FREE VS. SEDIMENT IS SIGNIFICANT (p-value = 0.001)
    ## R2 = 0.18408
beta.tax <- betadisper(fs.bray, fs.samp$Fraction)
p <- permutest(beta.tax)
p$tab
    ## SIGNIFICANT (p-value = 0.01)
    ## F = 23.51907

### Water vs. Sediment ###
ws.otu <- t(data.frame(otu_table(Ver.rel)))
ws.bray <- vegdist(ws.otu, method = "bray")
ws.samp <- data.frame(sample_data(Ver.rel))
adonis.fraction <- adonis(ws.bray ~ Origin, ws.samp)
    ## WATER VS. SEDIMENT IS SIGNIFICANT (p-value = 0.001)
    ## R2 = 0.08182
beta.tax = betadisper(fs.bray, fs.samp$Fraction)
p=permutest(beta.tax)
p$tab
    ## SIGNIFICANT (p-value = 0.01)
    ## F = 23.51907


####################### Depth #######################
adonis.depth <- adonis(test.bray ~ Depth, test.sample)
    ## SIGNIFICANT (p-value = 0.001)
    ## R2 = 0.11848
beta.tax = betadisper(test.bray, test.sample$Depth)
p=permutest(beta.tax)
p$tab
    ## SIGNIFICANT (p-value = 0.001)
    ## F = 19.93423

### Top vs. DCM vs. Bottom ###
tdb.phy <- subset_samples(Ver.rel, Depth != "Sediment")
tdb.otu <- t(data.frame(otu_table(tdb.phy)))
tdb.bray <- vegdist(tdb.otu, method = "bray")
tdb.samp <- data.frame(sample_data(tdb.phy))
adonis.depth <- adonis(tdb.bray ~ Depth, tdb.samp)
    ## WATER COLUMN DEPTH IS SIGNIFICANT (p-value = 0.001)
    ## R2 = 0.04064
beta.tax = betadisper(tdb.bray, tdb.samp$Depth)
p=permutest(beta.tax)
p$tab
    ## Not significant (p-value = 0.134)
    ## F = 1.990628



####################### Season #######################
adonis.date <- adonis(test.bray ~ Season, test.sample)
    ## SIGNIFICANT (p-value = 0.001)
    ## R2 = 0.09073
beta.tax = betadisper(test.bray, test.sample$Date)
p=permutest(beta.tax)
p$tab
    ## SIGNIFICANT (p-value = 0.001)
    ## F = 10.76313

### Spring vs. Summer ###
ss.phy <- subset_samples(Ver.rel, Season != "Fall")
ss.otu <- t(data.frame(otu_table(ss.phy)))
ss.bray <- vegdist(ss.otu, method = "bray")
ss.samp <- data.frame(sample_data(ss.phy))
adonis.date <- adonis(ss.bray ~ Date, ss.samp)
    ## SPRING VS. SUMMER IS SIGNIFICANT (p-value = 0.001)
    ## R2 = 0.18063
beta.tax = betadisper(ss.bray, ss.samp$Date)
p=permutest(beta.tax)
p$tab
    ## SIGNIFICANT (p-value = 0.001)
    ## F = 18.5581

### Spring vs. Fall###
sf.phy <- subset_samples(Ver.rel, Date != "Summer")
sf.otu <- t(data.frame(otu_table(sf.phy)))
sf.bray <- vegdist(sf.otu, method = "bray")
sf.samp <- data.frame(sample_data(sf.phy))
adonis.date <- adonis(sf.bray ~ Date, sf.samp)
    ## SPRING VS. FALL IS SIGNIFICANT (p-value = 0.001)
    ## R2 = 0.18122
beta.tax = betadisper(sf.bray, sf.samp$Date)
p=permutest(beta.tax)
p$tab
    ## SIGNIFICANT (p-value = 0.001)
    ## F = 10.76313

### Summer vs. Fall###
sf.phy <- subset_samples(Ver.rel, Date != "Spring")
sf.otu <- t(data.frame(otu_table(sf.phy)))
sf.bray <- vegdist(sf.otu, method = "bray")
sf.samp <- data.frame(sample_data(sf.phy))
adonis.date <- adonis(sf.bray ~ Date, sf.samp)
    ## SUMMER VS. FALL IS SIGNIFICANT (p-value = 0.001)
    ## R2 = 0.18122
beta.tax = betadisper(sf.bray, sf.samp$Date)
p=permutest(beta.tax)
p$tab
    ## SIGNIFICANT (p-value = 0.001)
    ## F = 10.76313


####################### Stacking factors for adonis! #######################
adonis.stack <- adonis(test.bray ~ Lake + Fraction, test.sample)
adonis.stack
    ## Lake R2 = 0.25706
    ## Fraction R2 = 0.17151
adonis.stack <- adonis(test.bray ~ Fraction + Lake, test.sample)
adonis.stack
    ## Fraction R2 = 0.16876
    ##Lake R2 = 0.25982
adonis.stack <- adonis(test.bray ~ Lake + Fraction + Depth, test.sample)
adonis.stack
    ## Lake R2 = 0.25706
    ## Fraction R2 = 0.17151
    ## Depth R2 = 0.03
adonis.stack <- adonis(test.bray ~ Lake + Depth + Fraction, test.sample)
adonis.stack
    ## Lake R2 = 0.25706
    ## Depth R2 = 0.11440
    ## Fraction R2 = 0.08719
adonis.stack <- adonis(test.bray ~ Lake + Fraction + Depth + Season, test.sample)
adonis.stack
    ## Lake R2 = 0.25706
    ## Fraction R2 = 0.17151
    ## Depth R2 = 0.03
    ## Season R2 = 0.06850
adonis.stack <- adonis(test.bray ~ Lake + Fraction + Season + Depth, test.sample) ##### I LIKE THIS ONE!!
adonis.stack
    ## Lake R2 = 0.25706
    ## Fraction R2 = 0.17151
    ## Season R2 = 0.06940
    ## Depth R2 = 0.02918
    ## Residual R2 = 0.47285 ###########unstac## WE CAN EXPLAIN OVER 50% OF THE VARIATION!!!!!!!!!!
adonis.stack <- adonis(test.bray ~ Lake + Season + Fraction + Depth, test.sample)
adonis.stack
    ## Lake R2 = 0.25706
    ## Season R2 = 0.07250
    ## Fraction R2 = 0.16841
    ## Depth R2 = 0.02918

##### CORRESPONDS TO THE NMDS & RANK ABUNDANCE PLOTS!!! #####
adonis.stack <- adonis(test.bray ~ Fraction + Group + Season + Depth, test.sample) 
adonis.stack
    ## Fraction R2 = 0.16876
    ## Group R2 = 0.11422
    ## Season R2 = 0.07149
    ## Depth R2 = 0.02918
    ## Residual R2 = 0.61652




############## PHYLOSEQ NMDS ##############
#http://joey711.github.io/phyloseq/plot_ordination-examples
Ver.nmds <- ordinate(Ver.rel, "NMDS", "bray")
plot_ordination(Ver.rel, Ver.nmds, type="Sample", color="Group", title="Group")
Ver.rel.otu <- data.frame(otu_table(Ver.rel))
Ver.rel.otu.bray <- vegdist(Ver.rel.otu, method="bray")
adonis.group <- adonis(Ver.rel.otu.bray~Group, as(sample_data(Ver.rel),"data.frame"))


```

### RELATIVE ABUNDANCE UNSTACKED BAR PLOT
```{r}
classVer <- tax_glom(Ver, taxrank = "Class")

# Calculate relative abundance
classVer.rel = transform_sample_counts(classVer, function(x){x/sum(x)})

# If a phylum has <1% rel abun, change that to 0%
otu_table(classVer.rel)[otu_table(classVer.rel)<.01] <- 0

# Remove anything with 0% rel abun
classVer.rel = prune_taxa(taxa_sums(classVer.rel)>0,classVer.rel)

# Create rank abundance of OTUs
barplot(sort(taxa_sums(classVer.rel),TRUE)[1:20]/nsamples(classVer.rel),las=2,cex.axis=.7)

# Create dataframe to use in ggplot
classVer.df <- psmelt(classVer.rel)
classVer.df$Abundance <- classVer.df$Abundance * 100
#classVer.df$Class <- ordered(classVer.df$Class, levels = c("Opitutae","Verrucomicrobiae","OPB35_soil_group", "Spartobacteria", "Verrucomicrobia_Incertae_Sedis", "unclassified", "S-BQ2-57_soil_group"))
classVer.df$Class <- ordered(classVer.df$Class, levels = c("S-BQ2-57_soil_group", "unclassified", "Verrucomicrobia_Incertae_Sedis", "Spartobacteria", "OPB35_soil_group", "Verrucomicrobiae", "Opitutae"))
classVer.df$Group <- ordered(classVer.df$Group, levels = c("Laurentian","Estuary","Inland"))
classVer.df$Fraction <- ordered(classVer.df$Fraction, levels = c("Particle","Free","Sediment"))
classVer.df$Depth <- ordered(classVer.df$Depth, levels = c("Top","DCM", "Bottom","Sediment"))
classVer.df$Season <- ordered(classVer.df$Season, levels = c("Spring","Summer","Fall"))

Ver.colors <- c(Opitutae = "red2", Verrucomicrobiae = "darkorange", "OPB35_soil_group" = "gold", Spartobacteria = "chartreuse3", "Verrucomicrobia_Incertae_Sedis" = "deepskyblue", unclassified = "mediumorchid3", "S-BQ2-57_soil_group" = "purple4")

#phylum.colors <- c(Proteobacteria = "deepskyblue", Actinobacteria = "royalblue", Cyanobacteria = "chartreuse3", Bacteroidetes = "darkorange", Planctomycetes = "mediumorchid3", Chloroflexi = "darkgreen", Verrucomicrobia = "purple4", Armatimonadetes = "red", "NPL-UPA2"="#652926", Chlorobi = "cyan2", Gemmatimonadetes = "black", Acidobacteria = "grey26", "Candidate_division_OP3" = "hotpink", Nitrospirae = "blue", "Candidate_division_OD1" = "brown", Spirochaetae = "gold3", "Candidate_division_OP8" = "goldenrod1", Chlamydiae = "violet", Lentisphaerae = "yellow1", "BD1-5" = "chartreuse", "TM6" = "olivedrab", unclassified = "grey", Firmicutes = "blue4", "Candidate_division_WS3"= "magenta", Fibrobacteres = "darkred", "Candidate_division_SR1" = "tan3" )






########### Create dataframe for unstacked bar plots (facet by Group & Fraction) ###########
classVer.rel.df <- psmelt(classVer.rel)
    ## This takes your entire phyloseq object & combines its constituents into one dataframe
sub.classVer.df <- subset(classVer.df, select = c("Sample","Class", "Abundance","Group","Fraction"))
    ## These are the factors that you'll be using to make your graph
groupfrac <- ddply(sub.classVer.df, c("Group","Fraction", "Class"), summarise,
                   n =  length(Abundance),
                   relabun = mean(Abundance),
                   sd = sd(Abundance),
                   se = sd/sqrt(n) )
    ## This takes one dataframe, applies a bunch of functions to it, and spits out the results
    ## into a new dataframe
    ## ddply ( dataframe.you.wanna.work.with, c("the factors you want to use"),
    ##         summarise (no clue what this adds to the output),
    ##         now all the functions/commands you want to apply

groupfrac$Class <- ordered(groupfrac$Class, levels = c("S-BQ2-57_soil_group", "unclassified", "Verrucomicrobia_Incertae_Sedis", "Spartobacteria", "OPB35_soil_group", "Verrucomicrobiae", "Opitutae"))
groupfrac$Group <- ordered(groupfrac$Group, levels = c("Laurentian","Estuary","Inland"))
groupfrac$Fraction <- ordered(groupfrac$Fraction, levels = c("Particle","Free","Sediment"))

Ver.colors <- c(Opitutae = "red3", Verrucomicrobiae = "darkorange", "OPB35_soil_group" = "gold", Spartobacteria = "chartreuse3", "Verrucomicrobia_Incertae_Sedis" = "steelblue1", unclassified = "mediumorchid3", "S-BQ2-57_soil_group" = "purple4")


###### GGPLOT IT! ######
tiff("unstackbar.tiff", width = 8, height = 5, units = "in", res = 500)
ggplot(groupfrac, aes(y=relabun, x = Class, fill = Class)) +
  facet_grid(Fraction ~ Group) +
  geom_bar(stat="identity", position=position_dodge()) +
  scale_fill_manual(values = Ver.colors, name = "Class") +
  theme_bw() + ggtitle("Verrucomicrobia Classes Above 0.1%") + coord_flip() +
  geom_errorbar(aes(ymin = relabun - se, ymax = relabun + se), width = 0.25) + 
  xlab("Class") + ylab("Mean Relative Abundance (%)") +
  theme(axis.title.x = element_text(face="bold", size=16),
        axis.text.x = element_text(angle=0, colour="black", size=12),
        axis.text.y = element_text(colour="black", size=12),
        axis.title.y = element_text(face="bold", size=16),
        plot.title = element_text(face="bold", size=20),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size = 12),
        legend.position="none")
dev.off()







########### Create dataframe for unstacked bar plots (facet by Season & Fraction) ###########
classVer.rel.df <- psmelt(classVer.rel)
    ## This takes your entire phyloseq object & combines its constituents into one dataframe
sub.classVer.df <- subset(classVer.df, select = c("Sample","Class", "Abundance","Season", "Fraction"))
    ## These are the factors that you'll be using to make your graph
groupfrac <- ddply(sub.classVer.df, c("Season", "Class", "Fraction"), summarise,
                   n =  length(Abundance),
                   relabun = mean(Abundance),
                   sd = sd(Abundance),
                   se = sd/sqrt(n) )
    ## This takes one dataframe, applies a bunch of functions to it, and spits out the results
    ## into a new dataframe
    ## ddply ( dataframe.you.wanna.work.with, c("the factors you want to use"),
    ##         summarise (no clue what this adds to the output),
    ##         now all the functions/commands you want to apply

groupfrac$Season <- ordered(groupfrac$Season, levels = c("Spring","Summer","Fall"))
groupfrac$Fraction <- ordered(groupfrac$Fraction, levels = c("Particle","Free","Sediment"))

Ver.colors <- c(Opitutae = "red3", Verrucomicrobiae = "darkorange", "OPB35_soil_group" = "gold", Spartobacteria = "chartreuse3", "Verrucomicrobia_Incertae_Sedis" = "steelblue1", unclassified = "mediumorchid3", "S-BQ2-57_soil_group" = "purple4")


###### GGPLOT IT! ######
#tiff("unstackbar.seasonfrac.tiff", width = 8, height = 5, units = "in", res = 500)
ggplot(groupfrac, aes(y=relabun, x = Class, fill = Class)) +
  facet_grid(Fraction ~ Season) +
  geom_bar(stat="identity", position=position_dodge()) +
  scale_fill_manual(values = Ver.colors, name = "Class") +
  theme_bw() + ggtitle("Verrucomicrobia Classes Above 0.1%") + coord_flip() +
  geom_errorbar(aes(ymin = relabun - se, ymax = relabun + se), width = 0.25) + 
  xlab("Class") + ylab("Mean Relative Abundance (%)") +
  theme(axis.title.x = element_text(face="bold", size=16),
        axis.text.x = element_text(angle=0, colour="black", size=12),
        axis.text.y = element_text(colour="black", size=12),
        axis.title.y = element_text(face="bold", size=16),
        plot.title = element_text(face="bold", size=20),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size = 12),
        legend.position="none")
#dev.off()




########### Create dataframe for unstacked bar plots (facet by Group & Season) ###########
classVer.rel.df <- psmelt(classVer.rel)
    ## This takes your entire phyloseq object & combines its constituents into one dataframe
sub.classVer.df <- subset(classVer.df, select = c("Sample","Class", "Abundance","Season", "Group"))
    ## These are the factors that you'll be using to make your graph
groupfrac <- ddply(sub.classVer.df, c("Season", "Class", "Group"), summarise,
                   n =  length(Abundance),
                   relabun = mean(Abundance),
                   sd = sd(Abundance),
                   se = sd/sqrt(n) )
    ## This takes one dataframe, applies a bunch of functions to it, and spits out the results
    ## into a new dataframe
    ## ddply ( dataframe.you.wanna.work.with, c("the factors you want to use"),
    ##         summarise (no clue what this adds to the output),
    ##         now all the functions/commands you want to apply

groupfrac$Season <- ordered(groupfrac$Season, levels = c("Spring","Summer","Fall"))
groupfrac$Group <- ordered(groupfrac$Group, levels = c("Laurentian","Estuary","Inland"))

Ver.colors <- c(Opitutae = "red3", Verrucomicrobiae = "darkorange", "OPB35_soil_group" = "gold", Spartobacteria = "chartreuse3", "Verrucomicrobia_Incertae_Sedis" = "steelblue1", unclassified = "mediumorchid3", "S-BQ2-57_soil_group" = "purple4")


###### GGPLOT IT! ######
tiff("unstackbar.groupseason.tiff", width = 8, height = 5, units = "in", res = 500)
ggplot(groupfrac, aes(y=relabun, x = Class, fill = Class)) +
  facet_grid(Season ~ Group) +
  geom_bar(stat="identity", position=position_dodge()) +
  scale_fill_manual(values = Ver.colors, name = "Class") +
  theme_bw() + ggtitle("Verrucomicrobia Classes Above 0.1%") + coord_flip() +
  geom_errorbar(aes(ymin = relabun - se, ymax = relabun + se), width = 0.25) + 
  xlab("Class") + ylab("Mean Relative Abundance (%)") +
  theme(axis.title.x = element_text(face="bold", size=16),
        axis.text.x = element_text(angle=0, colour="black", size=12),
        axis.text.y = element_text(colour="black", size=12),
        axis.title.y = element_text(face="bold", size=16),
        plot.title = element_text(face="bold", size=20),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size = 12),
        legend.position="none")
dev.off()





########### Create dataframe for unstacked bar plots (facet by Fraction ~ Depth) ###########
classVer.rel.df <- psmelt(classVer.rel)
    ## This takes your entire phyloseq object & combines its constituents into one dataframe
sub.classVer.df <- subset(classVer.df, select = c("Sample","Class", "Abundance","Depth", "Fraction"))
    ## These are the factors that you'll be using to make your graph
groupfrac <- ddply(sub.classVer.df, c("Depth", "Class", "Fraction"), summarise,
                   n =  length(Abundance),
                   relabun = mean(Abundance),
                   sd = sd(Abundance),
                   se = sd/sqrt(n) )
    ## This takes one dataframe, applies a bunch of functions to it, and spits out the results
    ## into a new dataframe
    ## ddply ( dataframe.you.wanna.work.with, c("the factors you want to use"),
    ##         summarise (no clue what this adds to the output),
    ##         now all the functions/commands you want to apply

groupfrac$Depth <- ordered(groupfrac$Depth, levels = c("Top","DCM","Bottom","Sediment"))
groupfrac$Fraction <- ordered(groupfrac$Fraction, levels = c("Particle","Free","Sediment"))


Ver.colors <- c(Opitutae = "red3", Verrucomicrobiae = "darkorange", "OPB35_soil_group" = "gold", Spartobacteria = "chartreuse3", "Verrucomicrobia_Incertae_Sedis" = "steelblue1", unclassified = "mediumorchid3", "S-BQ2-57_soil_group" = "purple4")


###### GGPLOT IT! ######
#tiff("unstackbar.depthfrac.tiff", width = 8, height = 5, units = "in", res = 500)
ggplot(groupfrac, aes(y=relabun, x = Class, fill = Class)) +
  facet_grid(Fraction ~ Depth) +
  geom_bar(stat="identity", position=position_dodge()) +
  scale_fill_manual(values = Ver.colors, name = "Class") +
  theme_bw() + ggtitle("Verrucomicrobia Classes Above 0.1%") + coord_flip() +
  geom_errorbar(aes(ymin = relabun - se, ymax = relabun + se), width = 0.25) + 
  xlab("Class") + ylab("Mean Relative Abundance (%)") +
  theme(axis.title.x = element_text(face="bold", size=16),
        axis.text.x = element_text(angle=0, colour="black", size=12),
        axis.text.y = element_text(colour="black", size=12),
        axis.title.y = element_text(face="bold", size=16),
        plot.title = element_text(face="bold", size=20),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size = 12),
        legend.position="none")
#dev.off()





#good_phylum_proteo <-tax_glom(merged_final,taxrank = "Phylum")
goodsamps_phylum <- tax_glom(good_phylum_proteo,taxrank = "Phylum")
goodsamps_phy_melt <- psmelt(goodsamps_phylum)  ##  Melt it into a dataframe 
sub_goodsamps_phy_melt <- subset(goodsamps_phy_melt, select = c("Sample", "ProdLevel", "quadrant", "Phylum","Abundance"))
TOTALS <- ddply(sub_goodsamps_phy_melt, c("Sample"), summarise, ##  Let's get the McMurdie and Holmes Scaled  Total for each sample 
                total   = sum(Abundance))   
sub_phy_melt_totals <- merge(sub_goodsamps_phy_melt, TOTALS, by = "Sample")  ### Merge phylum sums and the total numbers -> so we can calculate the Relative Abundance
sub_phy_melt_totals$RelAbundance <- sub_phy_melt_totals$Abundance/sub_phy_melt_totals$total  ## Calculate the relative abundance
sub_phy_melt_totals$PercentAbund <- sub_phy_melt_totals$RelAbundance * 100  ##  Calculate the Percent Abundance

####  Make a new dataframe with the percent abudance within the entire dataset!
phy_stats <- ddply(sub_phy_melt_totals, c("Phylum"), summarise, 
                   N = length(PercentAbund),
                   PercentPhy = mean(PercentAbund),
                   sd   = sd(PercentAbund),
                   se   = sd / sqrt(N))
abund <- subset(phy_stats,PercentPhy > 0.001)  # Only take the phyla that are more than 0.01% abundant

abund_ordered <- arrange(abund, desc(PercentPhy))

abund$Phylum <- factor(abund$Phylum,levels = c("Bacteroidetes", "Cyanobacteria", "Verrucomicrobia", "Betaproteobacteria", "Actinobacteria", "Planctomycetes",  "Alphaproteobacteria", "Deltaproteobacteria",
                                               "Gammaproteobacteria", "Chloroflexi", "Lentisphaerae", "Chlorobi", "Armatimonadetes", "Firmicutes", "Acidobacteria", "Spirochaetae", "Candidate_division_OD1",
                                               "NPL-UPA2", "Deinococcus-Thermus", "Candidate_division_OP3", "TM6", "Chlamydiae", "Epsilonproteobacteria", "TA18", "Fibrobacteres", "Candidate_division_SR1", 
                                               "Candidate_division_BRC1", "BD1-5", "Gemmatimonadetes", "Fusobacteria", "Candidate_division_WS3", "Tenericutes", "Elusimicrobia", "WCHB1-60", "Deferribacteres", 
                                               "Candidate_division_TM7", "Candidate_division_OP8", "SPOTSOCT00m83", "Thermotogae", "Candidate_division_OP11", "Dictyoglomi", "unclassified"))   

abund$Phylum = with(abund, factor(Phylum, levels = rev(levels(Phylum)))) 

#Relative abundance plot 
abund_plot <- ggplot(abund, aes(y=PercentPhy , x=Phylum))  +
  #geom_boxplot(fill = "magenta4", colour = "black") + 
  geom_bar(stat="identity", position=position_dodge(),  fill = "magenta4", colour = "black") +
  theme_bw() + ggtitle("Phyla Above 0.1% in All Samples") +
  xlab("Phylum") + ylab("Mean Relative Abundance (%)") +
  geom_errorbar(aes(ymin = PercentPhy -se, ymax = PercentPhy +se), width = 0.25) + coord_flip() +
  theme(axis.title.x = element_text(face="bold", size=16),
        axis.text.x = element_text(angle=0, colour = "black", size=14),
        axis.text.y = element_text(colour = "black", size=14),
        axis.title.y = element_text(face="bold", size=16),
        plot.title = element_text(face="bold", size = 20),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size = 12),
        legend.position="none"); abund_plot


```




### Extra Functions
```{r}
################# FUNCTION TO FIND NAS IN A DATAFRAME #################
nacols <- function(df) {
  colnames(df)[unlist(lapply(df, function(x) any(is.na(x))))]
}
```

