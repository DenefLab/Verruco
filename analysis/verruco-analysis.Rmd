---
title: "Freshwater Verrucocmicrobia"
author: "Edna Chiang"
date: "July 6, 2015"
output: html_document
---


### Load Libraries
```{r}
library(phyloseq)
packageVersion("phyloseq")
library(ggplot2)
library(ape)
library(vegan)
library(plyr)
library(dplyr)
library(scales)
library(grid)
library(reshape2)
library(phangorn)
library(phytools)
library(DESeq)
library(DESeq2)
library(pander)
library(ade4)
library(labdsv)
#library(shiny)
#library(shinyFiles)
#library(samr)
theme_set(theme_bw())
set.seed(1)
```

### Import Data
```{r}
load("VerrucoData.RData")
```


### Visualize overall phyloseq object
```{r verruco.visualize}
# Check the sequencing depth of each sample 
sums_verruco <- data.frame(colSums(otu_table(verruco)))
colnames(sums_verruco) <- "Sample_TotalSeqs"
sums_verruco$sample <- row.names(sums_verruco)
sums_verruco <- arrange(sums_verruco, Sample_TotalSeqs)

# Create a plot of the number of sequences per sample
ggplot(sums_verruco, aes(x=reorder(sample,Sample_TotalSeqs), y = Sample_TotalSeqs)) + 
  ylab("Number of Sequences per Sample") +
  geom_bar(stat = "identity", colour="black",fill="cornflowerblue")  + xlab("Sample Name") + 
  ggtitle("Total Number of Sequences per Sample") + 
  theme(axis.text.x = element_text(colour = "black", size=6, angle=45, hjust = 1, vjust = 1))

# Look at # of reads
ggplot(data.frame(sum = sample_sums(verruco)), aes(sum)) + 
  geom_histogram(colour = "white", fill = "blue") + 
  ggtitle("Sample read counts") + 
  xlab("total sequences")

# Min, Mean, Max of sample read counts
min(sample_sums(verruco))
mean(sample_sums(verruco))
max(sample_sums(verruco))
```


### Merge Duplicates & create new phyloseq object
```{r merge.dups}
# Merges duplicates
verr.dupmerge <- merge_samples(verruco, "Duplicates")

## Fix metadata of merged duplicates 
# Grab unique lines (first entry) from verruco phyloseq object metadata
unique.idx <- !(duplicated(sample_data(verruco)$Duplicates))
duplicate.metadata <- sample_data(verruco)[unique.idx, ]

# Fix SampleID and rownames
duplicate.metadata$SampleID <- duplicate.metadata$Duplicates
rownames(duplicate.metadata) <- duplicate.metadata$Duplicates

# Assign new metadata to phyloseq object
sample_data(verr.dupmerge) <- duplicate.metadata

```

### Visualize merged dataset
```{r visualize.verr.dupmerge}
# Check the sequencing depth of each sample 
sums_dupmerge <- data.frame(rowSums(otu_table(verr.dupmerge)))
colnames(sums_dupmerge) <- "Sample_TotalSeqs"
sums_dupmerge$sample <- row.names(sums_dupmerge)
sums_dupmerge <- arrange(sums_dupmerge, Sample_TotalSeqs)

# Create a plot of the number of sequences per sample
ggplot(sums_dupmerge, aes(x=reorder(sample, Sample_TotalSeqs), y = Sample_TotalSeqs)) + 
  ylab("Number of Sequences per Sample") +
  geom_bar(stat = "identity", colour="black",fill="cornflowerblue")  + xlab("Sample Name") + 
  ggtitle("Total Number of Sequences per Sample") + 
  theme(axis.text.x = element_text(colour = "black", size=6, angle=45, hjust = 1, vjust = 1))

# Look at # of reads
ggplot(data.frame(sum = sample_sums(verr.dupmerge)), aes(sum)) + 
  geom_histogram(colour = "white", fill = "blue") +
  ggtitle("Sample read counts") + 
  xlab("total sequences")

# Mean, max and min of sample read counts
min(sample_sums(verr.dupmerge))
mean(sample_sums(verr.dupmerge))
max(sample_sums(verr.dupmerge))
```


### Trim & normalize data based on # of reads/sequence depth
```{r scale.data}
# Function to normalize data
scale_reads <- function(physeq,n){
  physeq.scale <- transform_sample_counts(physeq, function(x) {round((n*x/sum(x)))})
  #otu_table(physeq.scale) = round(otu_table(physeq.scale))
  physeq.scale = prune_taxa(taxa_sums(physeq.scale) > 0, physeq.scale)
  return(physeq.scale)
}

# Normalize our dataset!
scaled <- scale_reads(verr.dupmerge,10468)   ### Scaled to 10,468 (minumum sample)
sample_data(scaled)$Group <- ordered(sample_data(scaled)$Group, levels=c("Laurentian", 
                                                                   "Estuary","Inland"))
sample_data(scaled)$Fraction <- ordered(sample_data(scaled)$Fraction,
                                     levels = c("Particle","Free","Sediment"))
sample_data(scaled)$Depth <- ordered(sample_data(scaled)$Depth,
                                  levels = c("Top","DCM", "Bottom","Sediment"))
sample_data(scaled)$Season <- ordered(sample_data(scaled)$Season,
                                   levels = c("Spring","Summer","Fall"))

# Check the sequencing depth of each sample 
sums_scaled <- data.frame(rowSums(otu_table(scaled)))
colnames(sums_scaled) <- "Sample_TotalSeqs"
sums_scaled$SampleID <- row.names(sums_scaled)
sums_scaled <- arrange(sums_scaled, Sample_TotalSeqs)

# Create a plot of the number of sequences per sample
ggplot(sums_scaled, aes(x=SampleID, y = Sample_TotalSeqs)) + 
  ylab("Number of Sequences per Sample") +
  geom_bar(stat = "identity", colour="black",fill="cornflowerblue")  + xlab("Sample Name") + 
  ggtitle("Total Number of Sequences per Sample") + 
  theme(axis.text.x = element_text(colour = "black", size=6, angle=45, hjust = 1, vjust = 1))

# Let's visualized our normalized dataset
ggplot(data.frame(sum = sample_sums(scaled)), aes(sum)) + 
  geom_histogram(colour = "black", fill = "deeppink") +
  ggtitle("Sample read counts") + 
  xlab("total sequences")
```


### Rank abundance curve of top 300 OTUs
```{r rankabund}
### Get top 500 most abundant OTUs
top300.taxa <- sort(taxa_sums(scaled), TRUE)[1:300]
top300.OTUs <- prune_taxa(names(top300.taxa), scaled)
top300.sums <- data.frame(taxa_sums(top300.OTUs))

ggplot(top300.sums,aes(x=row.names(top300.sums), y=taxa_sums.top300.OTUs.)) + 
  ylab("Number of Sequences per OTU") + scale_x_discrete(expand = c(0,0)) + 
  scale_y_continuous(expand = c(0,0)) + theme_classic() +
  geom_bar(stat="identity",colour="black",fill="darkturquoise")  + xlab("OTU Rank") + 
  ggtitle("Rank Abundance Curve of the Top 300 OTUs") + 
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
```



### Let's take a look at the phyla in our normalized dataset
```{r phyla.level, fig.height = 5, fig.width = 8.5}

# Merges things that have the same taxanomic rank
good_phylum <- tax_glom(scaled, taxrank = "Phylum")

# Transforms each merged phylum count to rel abun
phylum.99 = transform_sample_counts(good_phylum, function(x){(x/sum(x))*100})

# If a phylum has <1% rel abun, change that to 0%
otu_table(phylum.99)[otu_table(phylum.99) < 0.01] <- 0

# Remove anything with 0% rel abun
phylum.99 = prune_taxa(taxa_sums(phylum.99) > 0, phylum.99)

# Create rank abundance of OTUs
top5phyla.barplot <- barplot(sort(taxa_sums(phylum.99),TRUE)[1:5]/nsamples(phylum.99),
  las = 2,
  cex.axis = 0.7, 
  space = F, 
  names.arg = c("Proteobacteria", "Bacteroidetes","Actinobacteria", "Verrucomicrobia", "Cyanobacteria"), 
  col = c("khaki1", "mediumorchid3", "firebrick3", "lightslateblue", "chartreuse3"), 
  main = "Top 5 Bacterial Phyla", 
  xlab = "Phylum", 
  ylab = "Relative Abundance (%)", 
  ylim = c(0, 35), 
  las = 0
)

```

### STACKED BAR PLOT OF GROUPS
```{r, fig.width = 7, fig.height = 8}
################# TIME TO CREATE STACKED BAR PLOT OF GROUPS #################

# Merge samples by group
phy.group <- merge_samples(phylum.99, "Group")


## But this only sums them
phy.samp <- data.frame(sample_data(phy.group))

# Average groups
phy.otu <- data.frame(otu_table(phy.group))
phy <- data.frame(tax_table(phy.group))
phy.otu[1,] <- (phy.otu[1,]/64)
    ## Averaging Estuary
phy.otu[2,] <- (phy.otu[2,]/117)
    ## Averaging Inland
phy.otu[3,] <- (phy.otu[3,]/34)
    ## Averaging Laurentian
#colnames(phy.otu) <- c("Proteobacteria","Actinobacteria","Cyanobacteria","Bacteroidetes","Planctomycetes","Chloroflexi","Verrucomicrobia","Armatimonadetes","NPL-UPA2","Chlorobi","Gemmatimonadetes","Acidobacteria","Candidate_division_OP3","Nitrospirae","Candidate_division_OD1","Spirochaetae","Candidate_division_OP8","Chlamydiae","Lentisphaerae","BD1-5","TM6","unclassified","Firmicutes", "Candidate_division_WS3","Fibrobacteres","Candidate_division_SR1")
tphy.otu <- t(phy.otu)
phy.otu <- otu_table(tphy.otu, taxa_are_rows = T)
phy.tax <- tax_table(phy.group)
phy.samp <- sample_data(phy.group)
phy.group.merge <- merge_phyloseq(phy.tax, phy.otu, phy.samp)
    ## Makes new phyloseq object of 3 groups: Estuary, Inland, Laurentian
# Remove taxa with a relative abundane of less than 1%
otu_table(phy.group.merge)[otu_table(phy.group.merge) < 1] <- 0
phy.group.merge <- prune_taxa(taxa_sums(phy.group.merge) > 0, phy.group.merge)



        
########### MAKE OBJECT TO BE USED IN GGPLOT ###########
phylum_long <- psmelt(phy.group.merge)
phylum_sort <- arrange(phylum_long, Phylum)
phylum_sort$Sample <- factor(phylum_sort$Sample, levels = c("Laurentian", "Estuary", "Inland"))

# Set phylum plotting colors for 12 taxa
phylum.colors <- c(Acidobacteria="lightblue1",
                   Actinobacteria="firebrick",
                   Armatimonadetes="salmon",
                   Bacteroidetes="mediumorchid3",
                   Chlorobi="gold",
                   Chloroflexi="#ff7f00",
                   Cyanobacteria="#33a02c",
                   Nitrospirae="midnightblue",
                   Planctomycetes="deepskyblue",
                   Proteobacteria="khaki1",
                   Verrucomicrobia="lightslateblue",
                   unclassified="#662506")

# Set phylum plotting colors for 26 taxa
#phylum.colors <- c(Acidobacteria = "lightblue1", Actinobacteria = "firebrick3", Armatimonadetes = "salmon", "BD1-5" = "gold", Bacteroidetes = "mediumorchid3", "Candidate_division_OD1" = "tan", "Candidate_division_OP3" = "grey76", "Candidate_division_OP8" = "darkolivegreen1", "Candidate_division_SR1" = "cornflowerblue", "Candidate_division_WS3" = "purple4", Clamydiae = "violetred1", Chlorobi = "goldenrod", Chloroflexi = "firebrick4", Cyanobacteria = "chartreuse3", Fibrobacteres = "black", Firmicutes = "white", Gemmatimonadetes = "grey", Lentisphaerae = "yellow", "NPL-UPA2" = "hotpink", Nitrospirae = "midnightblue", Planctomycetes = "deepskyblue", Proteobacteria = "khaki1", Spirochaetae = "coral1", "TM6" = "slategray1", Verrucomicrobia = "lightslateblue", unclassified = "green4")
  
  #c(Proteobacteria = "deepskyblue", Actinobacteria = "royalblue", Cyanobacteria = "chartreuse3", Bacteroidetes = "darkorange", Planctomycetes = "mediumorchid3", Chloroflexi = "darkgreen", Verrucomicrobia = "purple4", Armatimonadetes = "red", "NPL-UPA2"="#652926", Chlorobi = "cyan2", Gemmatimonadetes = "black", Acidobacteria = "grey76", "Candidate_division_OP3" = "hotpink", Nitrospirae = "blue", "Candidate_division_OD1" = "brown", Spirochaetae = "gold3", "Candidate_division_OP8" = "goldenrod1", Chlamydiae = "violet", Lentisphaerae = "yellow1", "BD1-5" = "chartreuse", "TM6" = "olivedrab", unclassified = "grey", Firmicutes = "blue4", "Candidate_division_WS3"= "magenta", Fibrobacteres = "darkred", "Candidate_division_SR1" = "tan3" )
  
  #c(Acidobacteria = "grey26", Actinobacteria = "royalblue", Alphaproteobacteria = "plum2", Armatimonadetes = "red", Bacteroidetes = "darkorange", "BD1-5" = "chartreuse", Betaproteobacteria = "slateblue2", "Candidate_division_BRC1" = "violetred4", "Candidate_division_OD1" = "#6DDE88", "Candidate_division_OP3" = "hotpink", "Candidate_division_OP8" = "goldenrod1",  "Candidate_division_SR1" = "tan3", "Candidate_division_TM7" = "skyblue1", "Candidate_division_WS3" = "magenta", Chlamydiae="violet", Chlorobi="cyan2", Chloroflexi="darkgreen", Cyanobacteria = "chartreuse3", Deferribacteres = "slateblue3", "Deinococcus-Thermus" = "violetred", Deltaproteobacteria = "deepskyblue", Elusimicrobia = "yellow3", Epsilonproteobacteria = "lightskyblue", Fibrobacteres = "darkred", Firmicutes = "blue4", Fusobacteria = "slateblue1", Gammaproteobacteria = "steelblue4", Gemmatimonadetes="black", Lentisphaerae = "yellow1", "NPL-UPA2"="#652926", Planctomycetes = "mediumorchid3", Proteobacteria = "deepskyblue", Spirochaetae = "gold3", Tenericutes="pink", Thermotogae = "chocolate1", TM6 = "olivedrab", unclassified = "grey", Verrucomicrobia = "purple4", "WCHB1-60" = "palegreen")

# GGPLOT it

#tiff("stackbar.group.tiff", width = 7, height = 8, units = "in", res = 500)
ggplot(phylum_sort, aes(x=Sample, y=Abundance, fill=Phylum)) +
          geom_bar(stat="identity", position="fill", color="black") +
          scale_y_continuous(labels = percent_format()) +
          scale_fill_manual(values = phylum.colors, name="Phylum") + 
          theme(axis.title.x = element_text(size=16, face = "bold"),
                axis.text.x = element_text(angle=50, colour = "black", vjust=1, hjust = 1, size=14),
                axis.text.y = element_text(colour = "black", size=14),
                axis.title.y = element_text(size=16, face="bold"),
                plot.title = element_text(size = 18, face="bold"),
                legend.title = element_text(size=14),
                legend.text = element_text(size = 13),
                legend.position="right") +
          guides(fill = guide_legend(reverse = TRUE, keywidth = 1, keyheight = 1)) + 
          xlab("Group") +
          ylab("Relative Abundance (taxa>1%)") +
          ggtitle("Lake Bacterial Community Composition")
#dev.off()

```

### LOOKING AT INTRA-VERRUCO COMMUNITY
```{r}
phy.Ver <- subset_taxa(phylum.99, Phylum == "Verrucomicrobia")
# This is the relative abundance of Verrucos in each sample
# min, max, & mean
mins <- min(sample_sums(phy.Ver))
paste(c("The minimum sample read count is", mins))
means <- mean(sample_sums(phy.Ver))
paste(c("The mean sample read count is", means))
maxs <- max(sample_sums(phy.Ver))
paste(c("The max sample read count is", maxs))

# Merge samples by Group
phy.group.Ver <- merge_samples(phy.Ver, "Group")

# Average groups
group.Ver <- data.frame(otu_table(phy.group.Ver))
group.Ver[1,] <- (group.Ver[1,]/54)
    ## Averaging Estuary
group.Ver[2,] <- (group.Ver[2,]/117)
    ## Averaging Inland
group.Ver[3,] <- (group.Ver[3,]/45)
    ## Averaging Laurentian
#tgroup.Ver <- t(group.Ver)
#tgroup.Ver <- data.frame(tgroup.Ver)
group.Ver$Lake_Type <- rownames(group.Ver)

# Really crappy bar plot
# Averaged relative abundance of Verrucos in each group of lake
ggplot(data = group.Ver, aes(x = Lake_Type, y = Otu000064)) +
  geom_bar(stat = "identity", fill = "dark grey", colour = "black") 

# Unclassifed phylum
phy.unclas <- subset_taxa(phylum.99, Phylum == "unclassified")
# Relative abundance of unclassified taxa in each sample
# min, max, & mean
mins <- min(sample_sums(phy.unclas))
paste(c("The minimum sample read count is",mins))
means <- mean(sample_sums(phy.unclas))
paste(c("The mean sample read count is",means))
maxs <- max(sample_sums(phy.unclas))
paste(c("The max sample read count is",maxs))


```


### Separate out Verrucos
```{r}
# Phyloseq object of ALL Verruco OTUs
Ver <- subset_taxa(scaled, Phylum == "Verrucomicrobia")

# Check the sequencing depth of Verrucos each sample 
sums_Ver <- data.frame(rowSums(otu_table(Ver)))
colnames(sums_Ver) <- "Sample_TotalSeqs"
sums_Ver$sample <- row.names(sums_Ver)
sums_Ver <- arrange(sums_Ver, Sample_TotalSeqs)
summary(sums_Ver)

####  Create a plot of the number of Verruco sequences per sample
ggplot(sums_Ver, aes(x=reorder(sample, Sample_TotalSeqs), y = Sample_TotalSeqs)) + 
  ylab("Number of Sequences per Sample") +
  geom_bar(stat = "identity", colour="black",fill="cornflowerblue")  + xlab("Sample Name") + 
  ggtitle("Total Number of Sequences per Sample") + 
  theme(axis.text.x = element_text(colour = "black", size=6, angle=45, hjust = 1, vjust = 1))

# For additional analysis -> Removing Sediment samples
phy.Ver.water <- subset_samples(phy.Ver, Fraction != "Sediment")

```

### Making phy.Ver normal
```{r}
phy.Ver.otu <- as.numeric(otu_table(phy.Ver))
hist(phy.Ver.otu,
  breaks = seq(0, 0.5, by = 0.025), 
  xlab = "Relative Abundance", 
  main = "Original Histogram")
    ## NOT NORMAL
    ## SKEWED RIGHT
qqnorm(phy.Ver.otu)
qqline(phy.Ver.otu)
    ## NOT NORMAL

# Test for normality
shapiro.test(phy.Ver.otu)
    ## DEF not normal (p-value = 0)
ks.test(phy.Ver.otu, "pnorm", mean = mean(phy.Ver.otu), sd = sd(phy.Ver.otu))
    # NOT NORMAL (p-value = 0.01615)

##### Log Transformation #####
log.ver <- log(phy.Ver.otu)
hist(log.ver, breaks=18, main = "Log-Transformed Histogram", xlab = "Log(Relative Abundance)")
    ## LOOKS BEAUTIFUL!
qqnorm(log.ver)
qqline(log.ver)
    ## Looks slightly better...
shapiro.test(log.ver)
    ## p-value = 0.08386
    ## Barely non-significant...I want a bigger p-value
ks.test(log.ver, "pnorm", mean=mean(log.ver), sd=sd(log.ver))
    ## p-value = 0.5135
    ## This is A LOT better
############ The histogram looks great, & both shapiro & ks come out not significant
############ Although shapiro is close-ish to the edge, I think it's okay based on the histogram




####### Repeat for phy.Ver.water #######
phy.Ver.water.otu <- as.numeric(otu_table(phy.Ver.water))
hist(phy.Ver.water.otu, 
  breaks = seq(0, .5, by = 0.025), 
  xlab = "Relative Abundance", 
  main = "Original Histogram"
)
    ## NOT NORMAL
    ## SKEWED RIGHT
qqnorm(phy.Ver.water.otu)
qqline(phy.Ver.water.otu)
    ## NOT NORMAL

# Test for normality
shapiro.test(phy.Ver.water.otu)
    ## DEF not normal (p-value = 0)
ks.test(phy.Ver.water.otu, "pnorm", mean = mean(phy.Ver.water.otu), sd = sd(phy.Ver.water.otu))
    # NOT NORMAL (p-value = 0.0275)

##### Log Transformation #####
log.ver.water <- log(phy.Ver.water.otu)
hist(log.ver.water, breaks = 18, main = "Log-Transformed Histogram", xlab = "Log(Relative Abundance)")
    ## LOOKS BEAUTIFUL!
qqnorm(log.ver.water)
qqline(log.ver.water)
    ## Looks slightly better...
shapiro.test(log.ver.water)
    ## p-value = 0.05037
    ## Barely non-significant...I want a bigger p-value
ks.test(log.ver.water, "pnorm", mean = mean(log.ver.water), sd = sd(log.ver.water))
    ## p-value = 0.5383
    ## This is A LOT better




################ Import normal data in phy.Ver phyloseq object ################
phy.Ver.otu <- data.frame(otu_table(phy.Ver))
phy.Ver.otu[1, ] <- log.ver

phy.Ver.water.otu <- data.frame(otu_table(phy.Ver.water))
phy.Ver.water.otu[1, ] <- log.ver.water

################# THIS IS THE VERRUCO PHYLUM PHYLOSEQ OBJECT YOU'LL USE IN THE FUTURE #################
otu <- otu_table(phy.Ver.otu, taxa_are_rows = TRUE)
tax <- tax_table(phy.Ver)
samp <- sample_data(phy.Ver)
normal.Ver <- merge_phyloseq(tax, otu, samp)


```


### Box-And-Whisker Plots
```{r}
######## YOU'RE USING THE PHY.VER.OTU DATAFRAME WITH THE NORMAL DATA ########
tphy.Ver.otu <- t(phy.Ver.otu)
phy.Ver.samp.norm <- data.frame(sample_data(phy.Ver))
phy.Ver.samp.norm$Relative_Abundance <- tphy.Ver.otu[,1]
phy.Ver.samp.norm$Group <- ordered(phy.Ver.samp.norm$Group, levels=c("Laurentian","Estuary","Inland"))
phy.Ver.samp.norm$Lake <- ordered(phy.Ver.samp.norm$Lake, levels=c("Michigan", "Muskegon", "BigSeven", "Bishop", "Bruin", "Cedar", "Halfmoon", "Heron", "Independence", "Lobdell", "North", "Sand", "Whitmore", "Woodland"))
phy.Ver.samp.norm$Fraction <- ordered(phy.Ver.samp.norm$Fraction, levels = c("Particle", "Free", "Sediment"))
phy.Ver.samp.norm$Depth <- ordered(phy.Ver.samp.norm$Depth, levels = c("Top", "Bottom", "Sediment"))

phy.Ver.otu.box <- data.frame(otu_table(phy.Ver))
tphy.Ver.box <- t(phy.Ver.otu.box)
phy.Ver.samp <- data.frame(sample_data(phy.Ver))
phy.Ver.samp$Relative_Abundance <- tphy.Ver.box[,1]
phy.Ver.samp$Group <- ordered(phy.Ver.samp$Group, levels=c("Laurentian","Estuary","Inland"))
phy.Ver.samp$Lake <- ordered(phy.Ver.samp$Lake, levels=c("Michigan", "Muskegon", "BigSeven", "Bishop", "Bruin", "Cedar", "Halfmoon", "Heron", "Independence", "Lobdell", "North", "Sand", "Whitmore", "Woodland"))
phy.Ver.samp$Fraction <- ordered(phy.Ver.samp$Fraction, levels = c("Particle", "Free", "Sediment"))
phy.Ver.samp$Depth <- ordered(phy.Ver.samp$Depth, levels = c("Top", "Bottom", "Sediment"))



################### BOXPLOT BY GROUP & FRACTION ###################
tiff("boxplot.tiff", width = 7, height = 5, units = "in", res = 500)
boxplot(phy.Ver.samp$Relative_Abundance ~ phy.Ver.samp$Group + phy.Ver.samp$Fraction, xlab = "Sample", ylab = "Relative Abundance", main = "Verrucomicrobia Abundance", names = rep("",9))
dev.off()

group.box <- boxplot(phy.Ver.samp$Relative_Abundance ~ phy.Ver.samp$Group, xlab = "Group", ylab = "Relative Abundance")
pairwise.t.test(x = phy.Ver.samp.norm$Relative_Abundance, g=phy.Ver.samp.norm$Group, p.adjust="bonferroni")
    ## SIGNIFICANT btwn Estuary/Laurentian & Inland/Laurentian
    ## NOT SIGNIFICANT btwn Estuary & Inland

lake.box <- boxplot(phy.Ver.samp$Relative_Abundance ~ phy.Ver.samp$Lake, data = phy.Ver.samp, xlab = "Lake Type", ylab = "Relative Abundance", main = "Lake Type", ylim = c(0,0.45))
anova(lm(phy.Ver.samp$Relative_Abundance ~ phy.Ver.samp$Lake))
    ## Significant
pairwise.t.test(x = phy.Ver.samp.norm$Relative_Abundance, g=phy.Ver.samp.norm$Lake, p.adjust="bonferroni")
    ## SIGNIFICANT btwn Michigan/Muskegon, Michigan/Bruin, Michigan/Heron, Michigan/Independence, Michigan/North, Michigan/Sand, Michigan/Whitmore;; Michigan/Lobdell is on the cusp
    ## SIGNIFICANT btwn Muskegon/Michigan, Muskegon/North
    ## SIGNIFICANT btwn North & Michigan, Cedar

fraction.box <- boxplot(phy.Ver.samp$Relative_Abundance ~ phy.Ver.samp$Fraction, xlab = "Fraction", ylab = "Relative Abundance", main = "Fraction")
pairwise.t.test(x = phy.Ver.samp.norm$Relative_Abundance, g=phy.Ver.samp.norm$Fraction, p.adjust="bonferroni")
    ## SIGNIFICANT between Sed/Part & Sed/Free
    ## NOT SIGNIFICANT btwn Part & Free

depth.box <- boxplot(phy.Ver.samp$Relative_Abundance ~ phy.Ver.samp$Depth, xlab = "Depth", ylab = "Relative Abundance", main = "Depth")
pairwise.t.test(x = phy.Ver.samp.norm$Relative_Abundance, g=phy.Ver.samp.norm$Depth, p.adjust="bonferroni")
    ## SIGNIFICANT between Sed/Top & Sed/Bottom
    ## NOT SIGNIFICANT btwn Top & Bottom

date.box <- boxplot(phy.Ver.samp$Relative_Abundance ~ phy.Ver.samp$Season, xlab = "Season", ylab = "Relative Abundance", main = "Season")
pairwise.t.test(x = phy.Ver.samp.norm$Relative_Abundance, g=phy.Ver.samp.norm$Season, p.adjust="bonferroni")
    ## NOT SIGNIFICANT (p-value=1)

origin.box <- boxplot(phy.Ver.samp$Relative_Abundance ~ phy.Ver.samp$Origin, xlab = "Season", ylab = "Relative Abundance", main = "Season")
pairwise.t.test(x = phy.Ver.samp.norm$Relative_Abundance, g=phy.Ver.samp.norm$Origin, p.adjust="bonferroni")
    ## SIGNIFICANT (p-value = 0.001)


############################## Just water column samples (NO SEDIMENT) ##############################
######## YOU'RE USING THE PHY.VER.WATER.OTU DATAFRAME WITH THE NORMAL DATA ########
phy.Ver.water.otu <- data.frame(otu_table(phy.Ver.water))
tphy.Ver.water.otu <- t(phy.Ver.water.otu)
phy.Ver.water.samp <- data.frame(sample_data(phy.Ver.water))
phy.Ver.water.samp$Relative_Abundance <- tphy.Ver.water.otu[,1]
phy.Ver.water.samp$Group <- ordered(phy.Ver.water.samp$Group, levels=c("Laurentian","Estuary","Inland"))
phy.Ver.water.samp$Lake <- ordered(phy.Ver.water.samp$Lake, levels=c("Michigan", "Muskegon", "BigSeven", "Bishop", "Bruin", "Cedar", "Halfmoon", "Heron", "Independence", "Lobdell", "North", "Sand", "Whitmore", "Woodland"))
phy.Ver.water.samp$Fraction <- ordered(phy.Ver.water.samp$Fraction, levels = c("Particle", "Free"))
phy.Ver.water.samp$Depth <- ordered(phy.Ver.water.samp$Depth, levels = c("Top", "Bottom"))

### By Group ###
boxplot(phy.Ver.water.samp$Relative_Abundance ~ phy.Ver.water.samp$Group, xlab = "Lake Type", ylab = "Relative Abundance", main = "Lake Type")
pairwise.t.test(x = phy.Ver.water.samp$Relative_Abundance, g=phy.Ver.water.samp$Group, p.adjust="bonferroni")
    ## SIGNIFICANT btwn Estuary/Laurentian & Inland/Laurentian
    ## NOT SIGNIFICANT btwn Estuary & Inland

### By Lake ###
boxplot(phy.Ver.water.samp$Relative_Abundance ~ phy.Ver.water.samp$Lake, data = phy.Ver.samp, xlab = "Lake Type", ylab = "Relative Abundance", main = "Lake Type", ylim = c(0,0.45))
anova(lm(phy.Ver.water.samp$Relative_Abundance ~ phy.Ver.water.samp$Lake))
    ## Significant
pairwise.t.test(x = phy.Ver.water.samp$Relative_Abundance, g=phy.Ver.water.samp$Lake, p.adjust="bonferroni")
    ## SIGNIFICANT btwn Michigan/Muskegon, Michigan/Bruin, Michigan/Heron, Michigan/Independence, Michigan/North, Michigan/Sand, Michigan/Whitmore;; Michigan/Lobdell is on the cusp
    ## SIGNIFICANT btwn Muskegon/Michigan
    ## SIGNIFICANT btwn North & Michigan, BigSeven, Bishop, Bruin, Cedar

### By Fraction ###
boxplot(phy.Ver.water.samp$Relative_Abundance ~ phy.Ver.water.samp$Fraction, xlab = "Fraction", ylab = "Relative Abundance", main = "Fraction")
pairwise.t.test(x = phy.Ver.water.samp$Relative_Abundance, g=phy.Ver.water.samp$Fraction, p.adjust="bonferroni")
    ## NOT SIGNIFICANT btwn Part & Free

### By Depth ###
boxplot(phy.Ver.water.samp$Relative_Abundance ~ phy.Ver.water.samp$Depth, xlab = "Depth", ylab = "Relative Abundance", main = "Depth")
pairwise.t.test(x = phy.Ver.water.samp$Relative_Abundance, g=phy.Ver.water.samp$Depth, p.adjust="bonferroni")
    ## NOT SIGNIFICANT btwn Top & Bottom


################### REMOVING SED DOESN'T HAVE AN EFFECT ON SIG BY GROUP OR LAKE ###################
```

### Verruco Relative Abundaunce to test normality
```{r}
# Transforms each merged phylum count to rel abun
Ver.rel <- transform_sample_counts(Ver, function(x){x/sum(x)})

# If a phylum has <1% rel abun, change that to 0%
otu_table(Ver.rel)[otu_table(Ver.rel)<.01] <- 0

# Remove anything with 0% rel abun
Ver.rel = prune_taxa(taxa_sums(Ver.rel)>0,Ver.rel)

# Create rank abundance of OTUs
barplot(sort(taxa_sums(Ver.rel),TRUE)[1:20]/nsamples(Ver.rel),las=2,cex.axis=.7)
    ## 1 = OPB35_soil_group
    ## 2 = OPB35_soil_group
    ## 3 = Opitutae - vadinHA64
    ## 4 = Spartobacteria - Chthoniobacterales - FukuN18_freshwater_group
    ## 5 = Verrucomicrobiae - Verrucomicrobiales - Verrucomicrobiaceae

Ver.otu <- as.numeric(otu_table(Ver.rel))
hist(Ver.otu)
    ## So skewed that I can't even get a legit histogram from it
qqnorm(Ver.otu)
qqline(Ver.otu)
    ## Looks exponentially distributed

# Test for normality
shapiro.test(Ver.otu)
    ## Too many samples
ks.test(Ver.otu, "pnorm", mean=mean(Ver.otu), sd=sd(Ver.otu))
    # p-value = 0
    # Not normal
ks.test(Ver.otu, "pexp")
    ## p-value = 9
    ## not exponentially distributed
Ver.otu <- Ver.otu + 1

#### Log Transformation ####
Ver.log <- log(Ver.otu)
hist(Ver.log)
    ## Still not normal
    ## Skewed to the right
qqnorm(Ver.log)
qqline(Ver.log)
ks.test(Ver.log, "pnorm", mean=mean(Ver.otu), sd=sd(Ver.otu))
    ## p=value = 0
    ## Not normal

#################### Verruco Intra-Phylum Rel Abun is NOT NORMAL ####################

```



### NMDS (Bray-Curtis)
```{r}
nmds.bray <- ordinate(
  physeq = Ver.rel, 
  method = "NMDS", 
  distance = "bray"
)
    # Stress = 0.2112829

### Color = Depth, Shape = Group
plot_ordination(
  physeq = Ver.rel,
  ordination = nmds.bray,
  color = "Depth",
  shape = "Group") + 
  scale_color_manual(values = c("indianred1","green3","mediumpurple2", "skyblue")) +
  scale_shape_manual(values = c(15,17,16)) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3))) 



### Color = Group, Shape = Depth
bray.nmds.group.depth <- plot_ordination(
  physeq = Ver.rel,
  ordination = nmds.bray,
  color = "Group",
  shape = "Depth") + 
  scale_color_manual(values = c("indianred1","deepskyblue","mediumpurple2")) +
  ggtitle("Bray-Curtis Dissimilarity") +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3))) 



### Color = Fraction, Shape = Group
plot_ordination(
  physeq = Ver.rel,
  ordination = nmds.bray,
  color = "Fraction",
  shape = "Depth") + 
  scale_color_manual(values = c("indianred1","deepskyblue","mediumpurple2")) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3))) 



### Color = Season, Shape = Group
plot_ordination(
  physeq = Ver.rel,
  ordination = nmds.bray,
  color = "Season",
  shape = "Group") + 
  scale_color_manual(values = c("indianred1","deepskyblue","mediumpurple2")) +
  scale_shape_manual(values = c(15,17,16)) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3))) 



### Facet = Group, Color = Fraction, Shape = Season
plot_ordination(
  physeq = Ver.rel,
  ordination = nmds.bray,
  color = "Fraction",
  shape = "Season") + 
  scale_color_manual(values = c("blue3","gold","tan3")) +
  facet_wrap(facets = ~Group) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3))) 
  


### Facet = Group, Color = Season, Shape = Fraction
bray.nmds.facet <- plot_ordination(
  physeq = Ver.rel,
  ordination = nmds.bray,
  color = "Season",
  shape = "Fraction") + 
  scale_color_manual(values = c("indianred1","deepskyblue","mediumpurple2")) +
  facet_wrap(facets = ~Group) +
  ggtitle("Bray-Curtis Dissimilarity") +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3))) 

```



### NMDS (Sorensen)
``` {r soren}
###################################### SORENSEN NMDS ######################################
nowinOTU.df <- data.frame(otu_table(Ver.rel))
nmds.soren <- metaMDS(nowinOTU.df, distance="bray", binary=TRUE)
  # stress = 0.1934691 
nmds.soren <- data.frame(nmds.soren$points)
nmds.soren$names <- row.names(nmds.soren)
nowinSamp <- data.frame(sample_data(Ver.rel))
nmds.soren$Group <- nowinSamp$Group
nmds.soren$Lake <- nowinSamp$Lake
nmds.soren$Date <- nowinSamp$Date
nmds.soren$Site <- nowinSamp$Site
nmds.soren$Depth <- nowinSamp$Depth
nmds.soren$Fraction <- nowinSamp$Fraction
nmds.soren$Season <- nowinSamp$Season



### Color = Depth, Shape = Group
ggplot(nmds.soren, aes(MDS1*10, MDS2*10, color=Depth, shape = Group,)) +
  xlab("NMDS1") + ylab("NMDS2") + ggtitle("Sorensen Dissimilarity") +
  geom_point(size = 2, alpha = 1) + theme_bw() +
  scale_color_manual(name = "Depth", breaks = c("Top", "DCM", "Bottom", "Sediment"),
                     labels = c("Top", "DCM", "Bottom", "Sediment"),
                     values = c("indianred1","green3","mediumpurple2", "skyblue")) +
  scale_shape_manual(name = "Group", breaks = c("Laurentian","Estuary","Inland"),
                     labels = c("Laurentian","Estuary","Inland"),
                     values = c(15,17,16)) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3))) 


### Color = Group, Shape = Depth
soren.nmds.group.depth <- ggplot(nmds.soren, aes(MDS1*10, MDS2*10, color=Group, shape = Depth,)) +
  xlab("NMDS1") + ylab("NMDS2") + ggtitle("Sorensen Dissimilarity") +
  geom_point(size = 2, alpha = 1) + theme_bw() +
  scale_color_manual(values = c("indianred1","deepskyblue","mediumpurple2")) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3))) 




### Color = Fraction, Shape = Depth
ggplot(nmds.soren, aes(MDS1*10, MDS2*10, color=Fraction, shape = Depth,)) +
  xlab("NMDS1") + ylab("NMDS2") + ggtitle("Sorensen Dissimilarity") +
  geom_point(size = 2, alpha = 1) + theme_bw() +
  scale_color_manual(values = c("indianred1","deepskyblue","mediumpurple2")) +
  scale_shape_manual(values = c(17, 5, 16, 4)) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3))) 


### Facet = Group, Color = Fraction, Shape = Season
ggplot(nmds.soren, aes(MDS1*10, MDS2*10, color=Fraction, shape = Season,)) +
  xlab("NMDS1") + ylab("NMDS2") + ggtitle("Sorensen Dissimilarity") +
  geom_point(size = 2, alpha = 1) + theme_bw() +
  facet_grid(.~Group) +
  scale_color_manual(values = c("blue3","gold", "tan3")) +
  scale_shape_manual(values = c(17, 16, 15)) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3)))



### Facet = Group, Color = Season, Shape = Fraction
soren.nmds.facet <- ggplot(nmds.soren, aes(MDS1*10, MDS2*10, color=Season, shape = Fraction,)) +
  xlab("NMDS1") + ylab("NMDS2") + ggtitle("Sorensen Dissimilarity") +
  geom_point(size = 2, alpha = 1) + theme_bw() +
  facet_grid(.~Group) +
  scale_color_manual(values = c("indianred1","deepskyblue","mediumpurple2")) +
  scale_shape_manual(values = c(16, 17, 15)) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3)))

```



### Create NMDS comparison plots
```{r compare.nmds}
#tiff("nmds.compare.tiff", width = 14, height = 10, units = "in", res = 500)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(2,2, widths=c(1,1), heights=c(1.5,1.5)))))
print(bray.nmds.group.depth, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(bray.nmds.facet, vp=viewport(layout.pos.row=1, layout.pos.col=2))
print(soren.nmds.group.depth, vp=viewport(layout.pos.row=2, layout.pos.col=1))
print(soren.nmds.facet, vp=viewport(layout.pos.row=2, layout.pos.col=2))
#dev.off()

### Bray-Curtis seems to cluster a bit more clearly than Sorensen

```







### PCoA (Bray-Curtis)
```{r pcoa, echo=FALSE}
Ver.bray <- phyloseq::distance(physeq = Ver.rel, method = "bray")

Ver.pcoa <-
  ordinate(
    physeq = Ver.rel,
    method = "PCoA",
    distance = "bray"
  )


#To determine approximately how much variation the axes should explain:
#Ver.pcoa$values
#look for broken stick value

### Depth
plot_ordination(
  physeq = Ver.rel, 
  ordination = Ver.pcoa, 
  color = "Depth",
  axes = c(1, 2),
  title = "Bray-Curtis Dissimilarity") +
  scale_color_manual(values = c("indianred1","deepskyblue","mediumpurple2")) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3)))

### Group
plot_ordination(
  physeq = Ver.rel, 
  ordination = Ver.pcoa, 
  color = "Group",
  axes = c(2,3),
  title = "Bray-Curtis Dissimilarity") +
  scale_color_manual(values = c("indianred1","deepskyblue","mediumpurple2")) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3)))

### Color = Group, Shape = Depth
bray.pcoa.group.depth <- plot_ordination(
  physeq = Ver.rel, 
  ordination = Ver.pcoa, 
  color = "Group",
  shape = "Depth",
  axes = c(2,3),
  title = "Bray-Curtis Dissimilarity") +
  scale_color_manual(values = c("indianred1","deepskyblue","mediumpurple2")) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3)))

# Fraction PCoA
plot_ordination(
  physeq = Ver.rel, 
  ordination = Ver.pcoa, 
  color = "Fraction",
  shape = "Season",
  axes = c(1, 3),
  title = "Bray-Curtis Dissimilarity") +
  facet_wrap(facets = ~Group) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3)))

# Season PCoA
bray.pcoa.facet <- plot_ordination(
  physeq = Ver.rel, 
  ordination = Ver.pcoa, 
  color = "Season",
  shape = "Fraction",
  axes = c(1,2),
  title = "Bray-Curtis Dissimilarity") +
  facet_wrap(facets = ~Group) +
  scale_color_manual(values = c("indianred1","deepskyblue","mediumpurple2")) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3)))
```



### PCoA (Sorensen)
``` {r pcoa.sorensen}
test <- dsvdis(nowinOTU.df, index="sorensen")
soren.pcoa<- ordinate(physeq = Ver.rel, method = "PCoA", distance = test)

### Depth
plot_ordination(
  physeq = Ver.rel, 
  ordination = soren.pcoa, 
  color = "Depth",
  axes = c(1,2),
  title = "Sorensen Dissimilarity") +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold"))


### Group
plot_ordination(
  physeq = Ver.rel, 
  ordination = soren.pcoa, 
  color = "Group",
  axes = c(2,3),
  title = "Sorensen Dissimilarity") +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold"))


### Color = Group, Shape = Depth
soren.pcoa.group.depth <- plot_ordination(
  physeq = Ver.rel, 
  ordination = soren.pcoa, 
  color = "Group",
  shape = "Depth",
  axes = c(2,3),
  title = "Sorensen Dissimilarity") +
  scale_color_manual(values = c("indianred1","deepskyblue","mediumpurple2")) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3)))


### Facet = Group, Color = Fraction, Shape = Season
plot_ordination(
  physeq = Ver.rel, 
  ordination = soren.pcoa, 
  color = "Fraction",
  shape = "Season",
  axes = c(1, 3),
  title = "Sorensen Dissimilarity") +
  facet_wrap(facets = ~Group) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3)))

### Facet = Group, Color = Season, Shape = Fraction
soren.pcoa.facet <- plot_ordination(
  physeq = Ver.rel, 
  ordination = Ver.pcoa, 
  color = "Season",
  shape = "Fraction",
  axes = c(1,2),
  title = "Sorensen Dissimilarity") +
  facet_wrap(facets = ~Group) +
  scale_color_manual(values = c("indianred1","deepskyblue","mediumpurple2")) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3)))

```


### Create PCoA comparison plots
```{r compare.pcoa}
tiff("pcoa.compare.tiff", width = 14, height = 10, units = "in", res = 500)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(2,2, widths=c(1,1), heights=c(1.5,1.5)))))
print(bray.pcoa.group.depth, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(bray.pcoa.facet, vp=viewport(layout.pos.row=1, layout.pos.col=2))
print(soren.pcoa.group.depth, vp=viewport(layout.pos.row=2, layout.pos.col=1))
print(soren.pcoa.facet, vp=viewport(layout.pos.row=2, layout.pos.col=2))
dev.off()

### Bray-Curtis seems to cluster a bit more clearly than Sorensen

```



### PERMANOVA/Adonis
```{r permanova, echo=FALSE}
sampledf <- data.frame(sample_data(Ver.rel))

##### Depth #####
adonis(Ver.bray ~ Depth, data=sampledf)
  ## R2 = 0.12755
  ## p-value = 0.001
beta.tax = betadisper(d=Ver.bray, group=sampledf$Depth)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
  # F = 19.08252

# Top vs. Bottom
adonis.tb <- subset_samples(physeq = Ver.rel, Depth != "DCM")
adonis.tb <- subset_samples(physeq = adonis.tb, Depth != "Sediment")
adonis.tb.bray <- phyloseq::distance(physeq = adonis.tb, method = "bray")
adonis.tb <- data.frame(sample_data(adonis.tb))
adonis(adonis.tb.bray ~ Depth, data=adonis.tb)
  # p-value = 0.003
  # R2 = 0.01201
beta.tax = betadisper(d=adonis.tb.bray, group=adonis.tb$Depth)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.317
  # F = 1.021386

# Top vs. Sediment
adonis.ts <- subset_samples(physeq = Ver.rel, Depth != "DCM")
adonis.ts <- subset_samples(physeq = adonis.ts, Depth != "Bottom")
adonis.ts.bray <- phyloseq::distance(physeq = adonis.ts, method = "bray")
adonis.ts <- data.frame(sample_data(adonis.ts))
adonis(adonis.ts.bray ~ Depth, data=adonis.ts)
  # p-value = 0.001
  # R2 = 0.19255
beta.tax = betadisper(d=adonis.ts.bray, group=adonis.ts$Depth)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
  # F = 48.59091

# Bottom vs. Sediment
adonis.bs <- subset_samples(physeq = Ver.rel, Depth != "DCM")
adonis.bs <- subset_samples(physeq = adonis.bs, Depth != "Top")
adonis.bs.bray <- phyloseq::distance(physeq = adonis.bs, method = "bray")
adonis.bs <- data.frame(sample_data(adonis.bs))
adonis(adonis.bs.bray ~ Depth, data=adonis.bs)
  # p-value = 0.001
  # R2 = 0.18178
beta.tax = betadisper(d=adonis.bs.bray, group=adonis.bs$Depth)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
  # F = 46.04348 

print("Depth accounts for 12.76% of the data variation. The variance between water column samples and sediment samples is significantly different. However, the variance within water column samples is not significantly different. As visualized on the PCoA, sediment samples are tightly clustered together compared to the less tightly clustered water samples. As a result, despite a significant variance difference in Depth samples, because sediment samples are clearly distinct from water samples, I believe that the PERMANOVA results are not skewed by sample variance difference.")
print("Top and Bottom is significantly different, but R2 is so small (0.012) that this explains very little of the sample variation.")


##### Group #####
adonis(Ver.bray ~ Group, data=sampledf)
  ## R2 = 0.10849
  ## p-value = 0.001
beta.tax = betadisper(Ver.bray, sampledf$Group)
p <- permutest(beta.tax)
p$tab
  ## p-value = 0.895
  ## F = 0.119105

# Laurentian vs. Estuary
adonis.scaled.le <- subset_samples(physeq = scaled, Group != "Inland")
adonis.scaled.le.bray <- phyloseq::distance(physeq = adonis.scaled.le, method = "bray")
adonis.scaled.le <- data.frame(sample_data(adonis.scaled.le))
adonis(adonis.scaled.le.bray ~ Group, data=adonis.scaled.le)
  # p-value = 0.001
  # R2 = 0.07658 
beta.tax = betadisper(d=adonis.scaled.le.bray, group=adonis.scaled.le$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.081
  # F = 3.716424

# Laurentian vs. Inland
adonis.scaled.li <- subset_samples(physeq = scaled, Group != "Estuary")
adonis.scaled.li.bray <- phyloseq::distance(physeq = adonis.scaled.li, method = "bray")
adonis.scaled.li <- data.frame(sample_data(adonis.scaled.li))
adonis(adonis.scaled.li.bray ~ Group, data=adonis.scaled.li)
  # p-value = 0.001
  # R2 = 0.07212
beta.tax = betadisper(d=adonis.scaled.li.bray, group=adonis.scaled.li$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
  # F = 13.47688

# Estuary vs. Inland
adonis.scaled.ei <- subset_samples(physeq = scaled, Group != "Laurentian")
adonis.scaled.ei.bray <- phyloseq::distance(physeq = adonis.scaled.ei, method = "bray")
adonis.scaled.ei <- data.frame(sample_data(adonis.scaled.ei))
adonis(adonis.scaled.ei.bray ~ Group, data=adonis.scaled.ei)
  # p-value = 0.001
  # R2 = 0.07689
beta.tax = betadisper(d=adonis.scaled.ei.bray, group=adonis.scaled.ei$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.96
  # F = 0.002008325





##### Fraction #####
adonis(Ver.bray ~ Fraction, data=sampledf)
  ## p-value = 0.001
  ## R2 = 0.19524
beta.tax = betadisper(Ver.bray, sampledf$Fraction)
p <- permutest(beta.tax)
p$tab
  ## P-value = 0.001
  ## F = 29.76732

# Particle vs. Free
adonis.pf <- subset_samples(physeq = Ver.rel, Fraction != "Sediment")
adonis.pf.bray <- phyloseq::distance(physeq = adonis.pf, method = "bray")
adonis.pf <- data.frame(sample_data(adonis.pf))
adonis(adonis.pf.bray ~ Fraction, data=adonis.pf)
  # p-value = 0.001
  # R2 = 0.09799
beta.tax = betadisper(d=adonis.pf.bray, group=adonis.pf$Fraction)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
  # F = 27.67899

# Particle vs. Sediment
adonis.ps <- subset_samples(physeq = Ver.rel, Fraction != "Free")
adonis.ps.bray <- phyloseq::distance(physeq = adonis.ps, method = "bray")
adonis.ps <- data.frame(sample_data(adonis.ps))
adonis(adonis.ps.bray ~ Fraction, data=adonis.ps)
  # p-value = 0.001
  # R2 = 0.17335
beta.tax = betadisper(d=adonis.ps.bray, group=adonis.ps$Fraction)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
  # F = 49.36893

# Free vs. Sediment
adonis.fs <- subset_samples(physeq = Ver.rel, Fraction != "Particle")
adonis.fs.bray <- phyloseq::distance(physeq = adonis.fs, method = "bray")
adonis.fs <- data.frame(sample_data(adonis.fs))
adonis(adonis.fs.bray ~ Fraction, data=adonis.fs)
  # p-value = 0.001
  # R2 = 0.24494
beta.tax = betadisper(d=adonis.fs.bray, group=adonis.fs$Fraction)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
  # F = 15.73037

print("Fraction is only significant between Particle/Free vs. Sediment (so water vs. Sediment). Between Particle & Free, R2 = 0.98; however, fraction variance is significantly different")


##### Season #####
adonis(Ver.bray ~ Season, data=sampledf)
  ## p-value = 0.001
  ## R2 = 0.09783
beta.tax = betadisper(Ver.bray, sampledf$Season)
p <- permutest(beta.tax)
p$tab
  ## P-value = 0.01
  ## F = 4.741428

# Spring vs. Summer
adonis.ss <- subset_samples(physeq = Ver.rel, Season != "Fall")
adonis.ss.bray <- phyloseq::distance(physeq = adonis.ss, method = "bray")
adonis.ss <- data.frame(sample_data(adonis.ss))
adonis(adonis.ss.bray ~ Season, data=adonis.ss)
  # p-value = 0.001
  # R2 = 0.09052
beta.tax = betadisper(d=adonis.ss.bray, group=adonis.ss$Fraction)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
  # F = 18.84919

# Spring vs. Fall
adonis.sf <- subset_samples(physeq = Ver.rel, Season != "Summer")
adonis.sf.bray <- phyloseq::distance(physeq = adonis.sf, method = "bray")
adonis.sf <- data.frame(sample_data(adonis.sf))
adonis(adonis.sf.bray ~ Season, data=adonis.sf)
  # p-value = 0.001
  # R2 = 0.1431
beta.tax = betadisper(d=adonis.sf.bray, group=adonis.sf$Fraction)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
  # F = 27.70226

# Summer vs. Fall
adonis.suf <- subset_samples(physeq = Ver.rel, Season != "Spring")
adonis.suf.bray <- phyloseq::distance(physeq = adonis.suf, method = "bray")
adonis.suf <- data.frame(sample_data(adonis.suf))
adonis(adonis.suf.bray ~ Season, data=adonis.suf)
  # p-value = 0.001
  # R2 = 0.0301
beta.tax = betadisper(d=adonis.suf.bray, group=adonis.suf$Fraction)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
  # F = 15.59481


##### Nested adonis #####
adonis(Ver.bray ~ Depth + Group + Fraction + Season, data = sampledf)
  ## Depth & Group have highest R2 (0.12755 & 0.11110 respectively)
  ## Fraction (0.08329), Season (0.08176)
  ## Residuals = 0.59631 
  ## All p-values = 0.001

## Raw data explains 0.361 (R2)
  # Group, Depth, Fraction, Season (in order of R2)
## Relative abundance explains 0.409 (R2)
```



### PCoA of Whole Bacterial Community
```{r pcoa.bcc}
scaled.bray <- phyloseq::distance(physeq=scaled, method="bray")

scaled.pcoa <- ordinate(physeq = scaled, method = "PCoA", distance="bray")

### Color = Depth, Shape = Group
plot_ordination(
  physeq = scaled, 
  ordination = scaled.pcoa, 
  color = "Depth",
  shape = "Group",
  axes = c(1, 2),
  title = "Bray-Curtis Dissimilarity") +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3)))


### Color = Group, Shape = Depth
bcc.pcoa.group.depth <- plot_ordination(
  physeq = scaled, 
  ordination = scaled.pcoa, 
  color = "Group",
  shape = "Depth",
  axes = c(2, 3),
  title = "Bray-Curtis Dissimilarity") +
  scale_y_reverse()+
  scale_color_manual(values = c("indianred1","deepskyblue","mediumpurple2")) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3)))

### Facet = Group, Color = Season, Shape = Fraction
bcc.pcoa.facet <- plot_ordination(
  physeq = scaled, 
  ordination = scaled.pcoa, 
  color = "Season",
  shape = "Fraction",
  axes = c(1,2),
  title = "Bray-Curtis Dissimilarity") +
  facet_wrap(facets = ~Group) +
  scale_color_manual(values = c("indianred1","deepskyblue","mediumpurple2")) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3)))



```


### Compare Whole Bacterial Community with Verruco Community
```{r bcc.ver.pcoa}
tiff("bcc.ver.compare.tiff", width = 14, height = 10, units = "in", res = 500)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(2,2, widths=c(1,1), heights=c(1.5,1.5)))))
print(bray.pcoa.group.depth, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(bray.pcoa.facet, vp=viewport(layout.pos.row=1, layout.pos.col=2))
print(bcc.pcoa.group.depth, vp=viewport(layout.pos.row=2, layout.pos.col=1))
print(bcc.pcoa.facet, vp=viewport(layout.pos.row=2, layout.pos.col=2))
dev.off()

```

### PERMANOVA for Whole Bacterial Community
```{r adonis.bcc}
bcc.sampledf <- data.frame(sample_data(scaled))

##### Depth #####
adonis(scaled.bray ~ Depth, data=bcc.sampledf)
  ## R2 = 0.12468
  ## p-value = 0.001
beta.tax = betadisper(d=scaled.bray, group=bcc.sampledf$Depth)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
  # F = 11.40066 

# Top vs. Bottom
adonis.scaled.tb <- subset_samples(physeq = scaled, Depth != "DCM")
adonis.scaled.tb <- subset_samples(physeq = adonis.scaled.tb, Depth != "Sediment")
adonis.scaled.tb.bray <- phyloseq::distance(physeq = adonis.scaled.tb, method = "bray")
adonis.scaled.tb <- data.frame(sample_data(adonis.scaled.tb))
adonis(adonis.scaled.tb.bray ~ Depth, data=adonis.scaled.tb)
  # p-value = 0.001
  # R2 = 0.01989
beta.tax = betadisper(d=adonis.scaled.tb.bray, group=adonis.scaled.tb$Depth)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.002
  # F = 11.99703

# Top vs. Sediment
adonis.scaled.ts <- subset_samples(physeq = scaled, Depth != "DCM")
adonis.scaled.ts <- subset_samples(physeq = adonis.scaled.ts, Depth != "Bottom")
adonis.scaled.ts.bray <- phyloseq::distance(physeq = adonis.scaled.ts, method = "bray")
adonis.scaled.ts <- data.frame(sample_data(adonis.scaled.ts))
adonis(adonis.scaled.ts.bray ~ Depth, data=adonis.scaled.ts)
  # p-value = 0.001
  # R2 = 0.18956
beta.tax = betadisper(d=adonis.scaled.ts.bray, group=adonis.scaled.ts$Depth)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.003
  # F = 8.363528 

# Bottom vs. Sediment
adonis.scaled.bs <- subset_samples(physeq = scaled, Depth != "DCM")
adonis.scaled.bs <- subset_samples(physeq = adonis.scaled.bs, Depth != "Top")
adonis.scaled.bs.bray <- phyloseq::distance(physeq = adonis.scaled.bs, method = "bray")
adonis.scaled.bs <- data.frame(sample_data(adonis.scaled.bs))
adonis(adonis.scaled.bs.bray ~ Depth, data=adonis.scaled.bs)
  # p-value = 0.001
  # R2 = 0.15569 
beta.tax = betadisper(d=adonis.scaled.bs.bray, group=adonis.scaled.bs$Depth)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
  # F = 20.21171 


##### Group #####
adonis(scaled.bray ~ Group, data=bcc.sampledf)
  ## R2 = 0.09852
  ## p-value = 0.001
beta.tax = betadisper(scaled.bray, bcc.sampledf$Group)
p <- permutest(beta.tax)
p$tab
  ## p-value = 0.006
  ## F = 4.864458

# Laurentian vs. Estuary
adonis.scaled.le <- subset_samples(physeq = scaled, Group != "Inland")
adonis.scaled.le.bray <- phyloseq::distance(physeq = adonis.scaled.le, method = "bray")
adonis.scaled.le <- data.frame(sample_data(adonis.scaled.le))
adonis(adonis.scaled.le.bray ~ Group, data=adonis.scaled.le)
  # p-value = 0.001
  # R2 = 0.08753
beta.tax = betadisper(d=adonis.scaled.le.bray, group=adonis.scaled.le$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.703
  # F = 0.1425916

# Laurentian vs. Inland
adonis.scaled.li <- subset_samples(physeq = Ver.rel, Group != "Estuary")
adonis.scaled.li.bray <- phyloseq::distance(physeq = adonis.scaled.li, method = "bray")
adonis.scaled.li <- data.frame(sample_data(adonis.scaled.li))
adonis(adonis.scaled.li.bray ~ Group, data=adonis.scaled.li)
  # p-value = 0.001
  # R2 = 0.08059
beta.tax = betadisper(d=adonis.scaled.li.bray, group=adonis.scaled.li$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.513
  # F = 0.3893777

# Estuary vs. Inland
adonis.ei <- subset_samples(physeq = Ver.rel, Group != "Laurentian")
adonis.ei.bray <- phyloseq::distance(physeq = adonis.ei, method = "bray")
adonis.ei <- data.frame(sample_data(adonis.ei))
adonis(adonis.ei.bray ~ Group, data=adonis.ei)
  # p-value = 0.001
  # R2 = 0.07067
beta.tax = betadisper(d=adonis.ei.bray, group=adonis.ei$Group)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.961
  # F = 0.002008325 




##### Fraction #####
adonis(scaled.bray ~ Fraction, data=bcc.sampledf)
  ## p-value = 0.001
  ## R2 = 0.21837
beta.tax = betadisper(scaled.bray, bcc.sampledf$Fraction)
p <- permutest(beta.tax)
p$tab
  ## P-value = 0.001
  ## F = 53.14341 

# Particle vs. Free
adonis.scaled.pf <- subset_samples(physeq = scaled, Fraction != "Sediment")
adonis.scaled.pf.bray <- phyloseq::distance(physeq = adonis.scaled.pf, method = "bray")
adonis.scaled.pf <- data.frame(sample_data(adonis.scaled.pf))
adonis(adonis.scaled.pf.bray ~ Fraction, data=adonis.scaled.pf)
  # p-value = 0.001
  # R2 = 0.13634
beta.tax = betadisper(d=adonis.scaled.pf.bray, group=adonis.scaled.pf$Fraction)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
  # F = 106.0687 

# Particle vs. Sediment
adonis.scaled.ps <- subset_samples(physeq = scaled, Fraction != "Free")
adonis.scaled.ps.bray <- phyloseq::distance(physeq = adonis.scaled.ps, method = "bray")
adonis.scaled.ps <- data.frame(sample_data(adonis.scaled.ps))
adonis(adonis.scaled.ps.bray ~ Fraction, data=adonis.scaled.ps)
  # p-value = 0.001
  # R2 = 0.15058
beta.tax = betadisper(d=adonis.scaled.ps.bray, group=adonis.scaled.ps$Fraction)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
  # F = 29.2068 

# Free vs. Sediment
adonis.scaled.fs <- subset_samples(physeq = scaled, Fraction != "Particle")
adonis.scaled.fs.bray <- phyloseq::distance(physeq = adonis.scaled.fs, method = "bray")
adonis.scaled.fs <- data.frame(sample_data(adonis.scaled.fs))
adonis(adonis.scaled.fs.bray ~ Fraction, data=adonis.scaled.fs)
  # p-value = 0.001
  # R2 = 0.26093
beta.tax = betadisper(d=adonis.scaled.fs.bray, group=adonis.scaled.fs$Fraction)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.855
  # F = 0.02365651


##### Season #####
adonis(scaled.bray ~ Season, data=bcc.sampledf)
  ## p-value = 0.001
  ## R2 = 0.0819 
beta.tax = betadisper(scaled.bray, bcc.sampledf$Season)
p <- permutest(beta.tax)
p$tab
  ## P-value = 0.046
  ## F = 2.889659

# Spring vs. Summer
adonis.scaled.ss <- subset_samples(physeq = scaled, Season != "Fall")
adonis.scaled.ss.bray <- phyloseq::distance(physeq = adonis.scaled.ss, method = "bray")
adonis.scaled.ss <- data.frame(sample_data(adonis.scaled.ss))
adonis(adonis.scaled.ss.bray ~ Season, data=adonis.scaled.ss)
  # p-value = 0.001
  # R2 = 0.07834
beta.tax = betadisper(d=adonis.scaled.ss.bray, group=adonis.scaled.ss$Fraction)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
  # F = 51.59802

# Spring vs. Fall
adonis.scaled.sf <- subset_samples(physeq = scaled, Season != "Summer")
adonis.scaled.sf.bray <- phyloseq::distance(physeq = adonis.scaled.sf, method = "bray")
adonis.scaled.sf <- data.frame(sample_data(adonis.scaled.sf))
adonis(adonis.scaled.sf.bray ~ Season, data=adonis.scaled.sf)
  # p-value = 0.001
  # R2 = 0.09675 
beta.tax = betadisper(d=adonis.scaled.sf.bray, group=adonis.scaled.sf$Fraction)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
  # F = 22.58511 

# Summer vs. Fall
adonis.scaled.suf <- subset_samples(physeq = scaled, Season != "Spring")
adonis.scaled.suf.bray <- phyloseq::distance(physeq = adonis.scaled.suf, method = "bray")
adonis.scaled.suf <- data.frame(sample_data(adonis.scaled.suf))
adonis(adonis.scaled.suf.bray ~ Season, data=adonis.scaled.suf)
  # p-value = 0.001
  # R2 = 0.03054
beta.tax = betadisper(d=adonis.scaled.suf.bray, group=adonis.scaled.suf$Fraction)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.001
  # F = 29.63419


##### Nested adonis #####
adonis(scaled.bray ~ Depth + Fraction + Group + Season, data = bcc.sampledf)
  ## Depth & Fraction have highest R2 (0.12468 & 0.11545 respectively)
  ## Group (0.09573), Season ( 0.06651)
  ## Residuals = 0.59763 
  ## All p-values = 0.001

```


### Procrustes Analyses (Verruco vs. Whole Bacterial community)
```{r procrustes}
procrust <- procrustes(scaled.pcoa$vectors[,1:2], Ver.pcoa$vectors[,1:2], scale=FALSE,
                       symmetric=FALSE)
  # Calculates procrustes based upon coordinates on axes 1 & 2 of the Bray-Curtis PCoA
  # Sum of squares = 12.43
plot(procrust)
plot(procrust,kind=2)
pro <- protest(scaled.pcoa$vectors[,1:2], Ver.pcoa$vectors[,1:2])
  # p-value = 0.001
  # m12^2 (sum of squares) = 0.3896
  # correlation = 0.7813
plot(pro)


procrust2 <- procrustes(scaled.pcoa$vectors[,1:3], Ver.pcoa$vectors[,1:3], scale=FALSE,
                       symmetric=FALSE)
  # Calculates procrustes based upon coordinates on axes 1 & 2 of the Bray-Curtis PCoA
  # Sum of squares = 11.72
plot(procrust2)
plot(procrust2,kind=2)
pro2 <- protest(scaled.pcoa$vectors[,1:3], Ver.pcoa$vectors[,1:3])
  # p-value = 0.001
  # m12^2 (sum of squares) = 0.2891
  # correlation = 0.8431
plot(pro2)


procrust3 <- procrustes(scaled.pcoa$vectors[,2:3], Ver.pcoa$vectors[,2:3], scale=FALSE,
                       symmetric=FALSE)
  # Calculates procrustes based upon coordinates on axes 1 & 2 of the Bray-Curtis PCoA
  # Sum of squares = 7.538
plot(procrust3)
plot(procrust3,kind=2)
pro3 <- protest(scaled.pcoa$vectors[,2:3], Ver.pcoa$vectors[,2:3])
  # p-value = 0.001
  # m12^2 (sum of squares) = 0.3058
  # correlation = 0.8332
plot(pro2)




### Prepare to make a prettier Procrustes plot
# http://stackoverflow.com/questions/30325739/ggplot2-for-procrustes-rotation-in-vegan
pro.df <- data.frame(Dimension1=procrust2$Yrot[,1], Dimension2=procrust2$Yrot[,2],
                     xDimension1=procrust2$X[,1], xDimension2=procrust2$X[,2])
pro.df$Depth <- sample_data(Ver)$Depth
pro.df$Group <- sample_data(Ver)$Group
pro.df$Fraction <- sample_data(Ver)$Fraction
pro.df$Season <- sample_data(Ver)$Season

### Make a prettier Procrustes plot
# Basic
ggplot(pro.df) +
  geom_point(aes(x=Dimension1, y=Dimension2)) +
  geom_point(aes(x=xDimension1, y=xDimension2)) +
  geom_segment(aes(x=Dimension2, y=Dimension2, xend=xDimension1, yend=xDimension2),
               arrow=arrow(length=unit(0.2,"cm")), color="burlywood", alpha=0.5)

### Facet = Group, Color = Depth
ggplot(pro.df) +
  geom_point(aes(x=Dimension1, y=Dimension2, color=Depth, shape=Fraction)) +
  geom_point(aes(x=xDimension1, y=xDimension2, color=Depth, shape=Fraction)) +
  geom_segment(aes(x=Dimension2, y=Dimension2, xend=xDimension1, yend=xDimension2),
               arrow=arrow(length=unit(0.2,"cm")), color="burlywood", alpha=0.5) +
  facet_grid(~Group) +
  scale_color_manual(values = c("indianred1","green3","mediumpurple2", "skyblue")) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3)))

### Facet = Group, Color = Fraction, Shape = Season
ggplot(pro.df) +
  geom_point(aes(x=Dimension1, y=Dimension2, color=Fraction, shape=Season)) +
  geom_point(aes(x=xDimension1, y=xDimension2, color=Fraction, shape=Season)) +
  geom_segment(aes(x=Dimension2, y=Dimension2, xend=xDimension1, yend=xDimension2),
               arrow=arrow(length=unit(0.2,"cm")), color="burlywood", alpha=0.5) +
  facet_grid(~Group) +
  scale_color_manual(values = c("indianred1","skyblue","mediumpurple2")) +
  theme(axis.text.x = element_blank(), 
        axis.text.y = element_blank(),
        axis.title.x = element_text(face="bold", size=14),
        axis.title.y = element_text(face="bold", size=14),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size=12),
        axis.ticks = element_blank(),
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), #top, right, bottom, left
        plot.title = element_text(size = 16, face="bold")) +
  guides(color = guide_legend(order=1, override.aes=list(size=3)),
         shape = guide_legend(order=2, override.aes=list(size=3)))


```


### Co-interia Analysis
```{r cia}
# https://pbil.univ-lyon1.fr/R/pdf/course6.pdf
# http://pbil.univ-lyon1.fr/ade4/ade4-html/coinertia.html
# https://www.bioconductor.org/help/course-materials/2014/BioC2014/IntAnalysis.html
Ver.dudi <- dudi.pco(Ver.bray)
3
  # 3 axes since my Bray PCoA uses 3 axes
scaled.dudi <- dudi.pco(scaled.bray)
3
  # 3 axes since my Bray PCoA uses 3 axes
cia <- coinertia(scaled.dudi, Ver.dudi)
3
  # 3 axes since my Bray PCoA uses 3 axes
  # RV = 0.7467593
      # Closer to 1 means that the datasets are more similar
summary(cia)
plot(cia)
rv.comp <- RV.rtest(scaled.dudi$tab, Ver.dudi$tab, 999)
   # Observation = 0.7467594
  # p-value = 0.001 
hist(rv.comp$sim)


tiff("coinertia.tiff", width=25, height=20, units="in", res=500)
plot(cia)
dev.off()



lX = AxcX   Row scores (rows of scaled.dudi cols) 
mX = NorS   Normed row scores (rows of scaled.dudi) 
lY = AxcY   Row scores (rows of Ver.dudi) 
mY = NorS   Normed row scores (rows of Ver.dudi)  


s.label()


s.label(res.pca$li, xax = 1, yax = 2)

```




### RELATIVE ABUNDANCE UNSTACKED BAR PLOT
```{r}
classVer <- tax_glom(Ver, taxrank = "Class")

# Calculate relative abundance
classVer.rel = transform_sample_counts(classVer, function(x){x/sum(x)})

# If a phylum has <1% rel abun, change that to 0%
otu_table(classVer.rel)[otu_table(classVer.rel)<.01] <- 0

# Remove anything with 0% rel abun
classVer.rel = prune_taxa(taxa_sums(classVer.rel)>0,classVer.rel)

# Create rank abundance of OTUs
barplot(sort(taxa_sums(classVer.rel),TRUE)[1:20]/nsamples(classVer.rel),las=2,cex.axis=.7)

# Create dataframe to use in ggplot
classVer.df <- psmelt(classVer.rel)
classVer.df$Abundance <- classVer.df$Abundance * 100
#classVer.df$Class <- ordered(classVer.df$Class, levels = c("Opitutae","Verrucomicrobiae","OPB35_soil_group", "Spartobacteria", "Verrucomicrobia_Incertae_Sedis", "unclassified", "S-BQ2-57_soil_group"))
classVer.df$Class <- ordered(classVer.df$Class, levels = c("S-BQ2-57_soil_group", "unclassified", "Verrucomicrobia_Incertae_Sedis", "Spartobacteria", "OPB35_soil_group", "Verrucomicrobiae", "Opitutae"))
classVer.df$Group <- ordered(classVer.df$Group, levels = c("Laurentian","Estuary","Inland"))
classVer.df$Fraction <- ordered(classVer.df$Fraction, levels = c("Particle","Free","Sediment"))
classVer.df$Depth <- ordered(classVer.df$Depth, levels = c("Top","DCM", "Bottom","Sediment"))
classVer.df$Season <- ordered(classVer.df$Season, levels = c("Spring","Summer","Fall"))

Ver.colors <- c(Opitutae = "red2", Verrucomicrobiae = "darkorange", "OPB35_soil_group" = "gold", Spartobacteria = "chartreuse3", "Verrucomicrobia_Incertae_Sedis" = "deepskyblue", unclassified = "mediumorchid3", "S-BQ2-57_soil_group" = "purple4")

#phylum.colors <- c(Proteobacteria = "deepskyblue", Actinobacteria = "royalblue", Cyanobacteria = "chartreuse3", Bacteroidetes = "darkorange", Planctomycetes = "mediumorchid3", Chloroflexi = "darkgreen", Verrucomicrobia = "purple4", Armatimonadetes = "red", "NPL-UPA2"="#652926", Chlorobi = "cyan2", Gemmatimonadetes = "black", Acidobacteria = "grey26", "Candidate_division_OP3" = "hotpink", Nitrospirae = "blue", "Candidate_division_OD1" = "brown", Spirochaetae = "gold3", "Candidate_division_OP8" = "goldenrod1", Chlamydiae = "violet", Lentisphaerae = "yellow1", "BD1-5" = "chartreuse", "TM6" = "olivedrab", unclassified = "grey", Firmicutes = "blue4", "Candidate_division_WS3"= "magenta", Fibrobacteres = "darkred", "Candidate_division_SR1" = "tan3" )






########### Create dataframe for unstacked bar plots (facet by Group & Fraction) ###########
classVer.rel.df <- psmelt(classVer.rel)
    ## This takes your entire phyloseq object & combines its constituents into one dataframe
sub.classVer.df <- subset(classVer.df, select = c("Sample","Class", "Abundance","Group","Fraction"))
    ## These are the factors that you'll be using to make your graph
groupfrac <- ddply(sub.classVer.df, c("Group","Fraction", "Class"), summarise,
                   n =  length(Abundance),
                   relabun = mean(Abundance),
                   sd = sd(Abundance),
                   se = sd/sqrt(n) )
    ## This takes one dataframe, applies a bunch of functions to it, and spits out the results
    ## into a new dataframe
    ## ddply ( dataframe.you.wanna.work.with, c("the factors you want to use"),
    ##         summarise (no clue what this adds to the output),
    ##         now all the functions/commands you want to apply

groupfrac$Class <- ordered(groupfrac$Class, levels = c("S-BQ2-57_soil_group", "unclassified", "Verrucomicrobia_Incertae_Sedis", "Spartobacteria", "OPB35_soil_group", "Verrucomicrobiae", "Opitutae"))
groupfrac$Group <- ordered(groupfrac$Group, levels = c("Laurentian","Estuary","Inland"))
groupfrac$Fraction <- ordered(groupfrac$Fraction, levels = c("Particle","Free","Sediment"))

Ver.colors <- c(Opitutae = "red3", Verrucomicrobiae = "darkorange", "OPB35_soil_group" = "gold", Spartobacteria = "chartreuse3", "Verrucomicrobia_Incertae_Sedis" = "steelblue1", unclassified = "mediumorchid3", "S-BQ2-57_soil_group" = "purple4")


###### GGPLOT IT! ######
tiff("unstackbar.tiff", width = 8, height = 5, units = "in", res = 500)
ggplot(groupfrac, aes(y=relabun, x = Class, fill = Class)) +
  facet_grid(Fraction ~ Group) +
  geom_bar(stat="identity", position=position_dodge()) +
  scale_fill_manual(values = Ver.colors, name = "Class") +
  theme_bw() + ggtitle("Verrucomicrobia Classes Above 0.1%") + coord_flip() +
  geom_errorbar(aes(ymin = relabun - se, ymax = relabun + se), width = 0.25) + 
  xlab("Class") + ylab("Mean Relative Abundance (%)") +
  theme(axis.title.x = element_text(face="bold", size=16),
        axis.text.x = element_text(angle=0, colour="black", size=12),
        axis.text.y = element_text(colour="black", size=12),
        axis.title.y = element_text(face="bold", size=16),
        plot.title = element_text(face="bold", size=20),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size = 12),
        legend.position="none")
dev.off()







########### Create dataframe for unstacked bar plots (facet by Season & Fraction) ###########
classVer.rel.df <- psmelt(classVer.rel)
    ## This takes your entire phyloseq object & combines its constituents into one dataframe
sub.classVer.df <- subset(classVer.df, select = c("Sample","Class", "Abundance","Season", "Fraction"))
    ## These are the factors that you'll be using to make your graph
groupfrac <- ddply(sub.classVer.df, c("Season", "Class", "Fraction"), summarise,
                   n =  length(Abundance),
                   relabun = mean(Abundance),
                   sd = sd(Abundance),
                   se = sd/sqrt(n) )
    ## This takes one dataframe, applies a bunch of functions to it, and spits out the results
    ## into a new dataframe
    ## ddply ( dataframe.you.wanna.work.with, c("the factors you want to use"),
    ##         summarise (no clue what this adds to the output),
    ##         now all the functions/commands you want to apply

groupfrac$Season <- ordered(groupfrac$Season, levels = c("Spring","Summer","Fall"))
groupfrac$Fraction <- ordered(groupfrac$Fraction, levels = c("Particle","Free","Sediment"))

Ver.colors <- c(Opitutae = "red3", Verrucomicrobiae = "darkorange", "OPB35_soil_group" = "gold", Spartobacteria = "chartreuse3", "Verrucomicrobia_Incertae_Sedis" = "steelblue1", unclassified = "mediumorchid3", "S-BQ2-57_soil_group" = "purple4")


###### GGPLOT IT! ######
#tiff("unstackbar.seasonfrac.tiff", width = 8, height = 5, units = "in", res = 500)
ggplot(groupfrac, aes(y=relabun, x = Class, fill = Class)) +
  facet_grid(Fraction ~ Season) +
  geom_bar(stat="identity", position=position_dodge()) +
  scale_fill_manual(values = Ver.colors, name = "Class") +
  theme_bw() + ggtitle("Verrucomicrobia Classes Above 0.1%") + coord_flip() +
  geom_errorbar(aes(ymin = relabun - se, ymax = relabun + se), width = 0.25) + 
  xlab("Class") + ylab("Mean Relative Abundance (%)") +
  theme(axis.title.x = element_text(face="bold", size=16),
        axis.text.x = element_text(angle=0, colour="black", size=12),
        axis.text.y = element_text(colour="black", size=12),
        axis.title.y = element_text(face="bold", size=16),
        plot.title = element_text(face="bold", size=20),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size = 12),
        legend.position="none")
#dev.off()




########### Create dataframe for unstacked bar plots (facet by Group & Season) ###########
classVer.rel.df <- psmelt(classVer.rel)
    ## This takes your entire phyloseq object & combines its constituents into one dataframe
sub.classVer.df <- subset(classVer.df, select = c("Sample","Class", "Abundance","Season", "Group"))
    ## These are the factors that you'll be using to make your graph
groupfrac <- ddply(sub.classVer.df, c("Season", "Class", "Group"), summarise,
                   n =  length(Abundance),
                   relabun = mean(Abundance),
                   sd = sd(Abundance),
                   se = sd/sqrt(n) )
    ## This takes one dataframe, applies a bunch of functions to it, and spits out the results
    ## into a new dataframe
    ## ddply ( dataframe.you.wanna.work.with, c("the factors you want to use"),
    ##         summarise (no clue what this adds to the output),
    ##         now all the functions/commands you want to apply

groupfrac$Season <- ordered(groupfrac$Season, levels = c("Spring","Summer","Fall"))
groupfrac$Group <- ordered(groupfrac$Group, levels = c("Laurentian","Estuary","Inland"))

Ver.colors <- c(Opitutae = "red3", Verrucomicrobiae = "darkorange", "OPB35_soil_group" = "gold", Spartobacteria = "chartreuse3", "Verrucomicrobia_Incertae_Sedis" = "steelblue1", unclassified = "mediumorchid3", "S-BQ2-57_soil_group" = "purple4")


###### GGPLOT IT! ######
tiff("unstackbar.groupseason.tiff", width = 8, height = 5, units = "in", res = 500)
ggplot(groupfrac, aes(y=relabun, x = Class, fill = Class)) +
  facet_grid(Season ~ Group) +
  geom_bar(stat="identity", position=position_dodge()) +
  scale_fill_manual(values = Ver.colors, name = "Class") +
  theme_bw() + ggtitle("Verrucomicrobia Classes Above 0.1%") + coord_flip() +
  geom_errorbar(aes(ymin = relabun - se, ymax = relabun + se), width = 0.25) + 
  xlab("Class") + ylab("Mean Relative Abundance (%)") +
  theme(axis.title.x = element_text(face="bold", size=16),
        axis.text.x = element_text(angle=0, colour="black", size=12),
        axis.text.y = element_text(colour="black", size=12),
        axis.title.y = element_text(face="bold", size=16),
        plot.title = element_text(face="bold", size=20),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size = 12),
        legend.position="none")
dev.off()





########### Create dataframe for unstacked bar plots (facet by Fraction ~ Depth) ###########
classVer.rel.df <- psmelt(classVer.rel)
    ## This takes your entire phyloseq object & combines its constituents into one dataframe
sub.classVer.df <- subset(classVer.df, select = c("Sample","Class", "Abundance","Depth", "Fraction"))
    ## These are the factors that you'll be using to make your graph
groupfrac <- ddply(sub.classVer.df, c("Depth", "Class", "Fraction"), summarise,
                   n =  length(Abundance),
                   relabun = mean(Abundance),
                   sd = sd(Abundance),
                   se = sd/sqrt(n) )
    ## This takes one dataframe, applies a bunch of functions to it, and spits out the results
    ## into a new dataframe
    ## ddply ( dataframe.you.wanna.work.with, c("the factors you want to use"),
    ##         summarise (no clue what this adds to the output),
    ##         now all the functions/commands you want to apply

groupfrac$Depth <- ordered(groupfrac$Depth, levels = c("Top","DCM","Bottom","Sediment"))
groupfrac$Fraction <- ordered(groupfrac$Fraction, levels = c("Particle","Free","Sediment"))


Ver.colors <- c(Opitutae = "red3", Verrucomicrobiae = "darkorange", "OPB35_soil_group" = "gold", Spartobacteria = "chartreuse3", "Verrucomicrobia_Incertae_Sedis" = "steelblue1", unclassified = "mediumorchid3", "S-BQ2-57_soil_group" = "purple4")


###### GGPLOT IT! ######
#tiff("unstackbar.depthfrac.tiff", width = 8, height = 5, units = "in", res = 500)
ggplot(groupfrac, aes(y=relabun, x = Class, fill = Class)) +
  facet_grid(Fraction ~ Depth) +
  geom_bar(stat="identity", position=position_dodge()) +
  scale_fill_manual(values = Ver.colors, name = "Class") +
  theme_bw() + ggtitle("Verrucomicrobia Classes Above 0.1%") + coord_flip() +
  geom_errorbar(aes(ymin = relabun - se, ymax = relabun + se), width = 0.25) + 
  xlab("Class") + ylab("Mean Relative Abundance (%)") +
  theme(axis.title.x = element_text(face="bold", size=16),
        axis.text.x = element_text(angle=0, colour="black", size=12),
        axis.text.y = element_text(colour="black", size=12),
        axis.title.y = element_text(face="bold", size=16),
        plot.title = element_text(face="bold", size=20),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size = 12),
        legend.position="none")
#dev.off()





#good_phylum_proteo <-tax_glom(merged_final,taxrank = "Phylum")
goodsamps_phylum <- tax_glom(good_phylum_proteo,taxrank = "Phylum")
goodsamps_phy_melt <- psmelt(goodsamps_phylum)  ##  Melt it into a dataframe 
sub_goodsamps_phy_melt <- subset(goodsamps_phy_melt, select = c("Sample", "ProdLevel", "quadrant", "Phylum","Abundance"))
TOTALS <- ddply(sub_goodsamps_phy_melt, c("Sample"), summarise, ##  Let's get the McMurdie and Holmes Scaled  Total for each sample 
                total   = sum(Abundance))   
sub_phy_melt_totals <- merge(sub_goodsamps_phy_melt, TOTALS, by = "Sample")  ### Merge phylum sums and the total numbers -> so we can calculate the Relative Abundance
sub_phy_melt_totals$RelAbundance <- sub_phy_melt_totals$Abundance/sub_phy_melt_totals$total  ## Calculate the relative abundance
sub_phy_melt_totals$PercentAbund <- sub_phy_melt_totals$RelAbundance * 100  ##  Calculate the Percent Abundance

####  Make a new dataframe with the percent abudance within the entire dataset!
phy_stats <- ddply(sub_phy_melt_totals, c("Phylum"), summarise, 
                   N = length(PercentAbund),
                   PercentPhy = mean(PercentAbund),
                   sd   = sd(PercentAbund),
                   se   = sd / sqrt(N))
abund <- subset(phy_stats,PercentPhy > 0.001)  # Only take the phyla that are more than 0.01% abundant

abund_ordered <- arrange(abund, desc(PercentPhy))

abund$Phylum <- factor(abund$Phylum,levels = c("Bacteroidetes", "Cyanobacteria", "Verrucomicrobia", "Betaproteobacteria", "Actinobacteria", "Planctomycetes",  "Alphaproteobacteria", "Deltaproteobacteria",
                                               "Gammaproteobacteria", "Chloroflexi", "Lentisphaerae", "Chlorobi", "Armatimonadetes", "Firmicutes", "Acidobacteria", "Spirochaetae", "Candidate_division_OD1",
                                               "NPL-UPA2", "Deinococcus-Thermus", "Candidate_division_OP3", "TM6", "Chlamydiae", "Epsilonproteobacteria", "TA18", "Fibrobacteres", "Candidate_division_SR1", 
                                               "Candidate_division_BRC1", "BD1-5", "Gemmatimonadetes", "Fusobacteria", "Candidate_division_WS3", "Tenericutes", "Elusimicrobia", "WCHB1-60", "Deferribacteres", 
                                               "Candidate_division_TM7", "Candidate_division_OP8", "SPOTSOCT00m83", "Thermotogae", "Candidate_division_OP11", "Dictyoglomi", "unclassified"))   

abund$Phylum = with(abund, factor(Phylum, levels = rev(levels(Phylum)))) 

#Relative abundance plot 
abund_plot <- ggplot(abund, aes(y=PercentPhy , x=Phylum))  +
  #geom_boxplot(fill = "magenta4", colour = "black") + 
  geom_bar(stat="identity", position=position_dodge(),  fill = "magenta4", colour = "black") +
  theme_bw() + ggtitle("Phyla Above 0.1% in All Samples") +
  xlab("Phylum") + ylab("Mean Relative Abundance (%)") +
  geom_errorbar(aes(ymin = PercentPhy -se, ymax = PercentPhy +se), width = 0.25) + coord_flip() +
  theme(axis.title.x = element_text(face="bold", size=16),
        axis.text.x = element_text(angle=0, colour = "black", size=14),
        axis.text.y = element_text(colour = "black", size=14),
        axis.title.y = element_text(face="bold", size=16),
        plot.title = element_text(face="bold", size = 20),
        legend.title = element_text(size=12, face="bold"),
        legend.text = element_text(size = 12),
        legend.position="none"); abund_plot


```


### DESeq
```{r relabund, echo=FALSE}
# DESeq bible: https://www.bioconductor.org/packages/3.3/bioc/vignettes/DESeq/inst/doc/DESeq.pdf
# Phyloseq to DESeq2: http://joey711.github.io/phyloseq-extensions/DESeq2.html
# Phyloseq to DESeq: http://joey711.github.io/phyloseq-extensions/DESeq.html


### DESeq2 ###
# Editing phyloseq object because there can be no 0's
Ver.out.out1 <- otu_table(Ver.out) + 1
Ver.out.samp <- sample_data(Ver.out)
Ver.out.tax <- tax_table(Ver.out)
Ver.out.1 <- merge_phyloseq(Ver.out.out1, Ver.out.samp, Ver.out.tax)


# Let's look at Source (water vs. sed)
Vsource <- phyloseq_to_deseq2(physeq = Ver.out.1, design = ~ Group+Season+Source)
  # I left out Depth & Fraction because those all take into account water vs. sediment
  # Looks the same whether you control or not
Vsource <- DESeq(object = Vsource, test="Wald", fitType="local")
plotDispEsts(object = Vsource)
source.res <- results(Vsource, cooksCutoff=FALSE)
  # Sediment = negative
  # Water = positive
#plotMA(source.res, main="DESeq2", ylim=c(-2,2))
  # MA plot of DEseq results; red= p-value < 0.1
  # You want this plot to be mostly symmetrical around the x-axis (at 0)
#resMLE <- results(Vsource, addMLE=TRUE)
#head(resMLE, 4)
#plotMA(resMLE, MLE=TRUE, main="unshrunken LFC", ylim=c(-2,2))

# Let's pull out all the OTUs that are overrepresented in Sediment
source.ma <- as.matrix(source.res)
sed <- which(source.res$log2FoldChange < 0)
sed.otus <- rownames(source.ma[sed,])

# Let's pull out all the OTUs that are overrepresented in Water
water <- which(source.res$log2FoldChange > 0)
water.otus <- rownames(source.ma[water,])

# Getting ready to plot!
alpha <- 0.01
sigtab <- source.res[which(source.res$padj < alpha),]
sigtab <- cbind(as(sigtab, "data.frame"), as(tax_table(Ver.out.1)[rownames(sigtab),], "matrix"))
ggplot(sigtab, aes(x=Species, y=log2FoldChange, color=Class)) + geom_point() +
  scale_color_brewer (palette="Set1")



# Now let's isolate Verrucos in water
Ver.water <- subset_samples(Ver.out.1, Depth != "Sediment")
Ver.water <- subset_samples(Ver.water, Depth != "DCM")
  # We want binary, so remove DCM too
# Create DESeq2 object
Vwd <- phyloseq_to_deseq2(physeq = Ver.water, design = ~ Group+Season+Depth )
Vwd <- DESeq(object = Vwd, test="Wald", fitType="local")
plotDispEsts(object = Vwd)
  # Dispersion increases over normalized mean count, so use fitType = "local"
    # https://support.bioconductor.org/p/63244/
# Summarize results
Vwd.res <- results(Vwd, cooksCutoff=FALSE)
  # Bottom = Negative
  # Top = Positive
#plotMA(Vwd.res, main="DESeq2", ylim=c(-2,2))
  # MA plot of DEseq results; red= p-value < 0.1
  # You want this plot to be mostly symmetrical around the x-axis (at 0)
#resMLE <- results(Vwd, addMLE=TRUE)
#head(resMLE, 4)
#plotMA(resMLE, MLE=TRUE, main="unshrunken LFC", ylim=c(-2,2))

# Let's pull out all the OTUs that are overrepresented in Bottom
water.df <- data.frame(Vwd.res)
water.bot <- which(water.df$log2FoldChange < 0)
water.bot.otus <- rownames(water.df[water.bot,])
# Let's pull out all the OTUs that are overrepresented in Top
water.top <- which(water.df$log2FoldChange > 0)
water.top.otus <- rownames(water.df[water.top,])
# Getting ready to plot
alpha <- 0.01
sigtab <- res[which(res$padj < alpha),]
sigtab <- cbind(as(sigtab, "data.frame"), as(tax_table(Ver.water)[rownames(sigtab),], "matrix"))
ggplot(sigtab, aes(x=Species, y=log2FoldChange, color=Class)) + geom_point() +
  scale_color_brewer (palette="Set1")


# Verrucos in Bottom vs. Sediment
Ver.bs <- subset_samples(Ver.out.1, Depth != "Top")
Ver.bs <- subset_samples(Ver.bs, Depth != "DCM")
# Create DESeq2 object
Vbs <- phyloseq_to_deseq2(physeq = Ver.bs, design = ~ Group+Season+Depth )
Vbs <- DESeq(object = Vbs, test="Wald", fitType="local")
plotDispEsts(object = Vbs)
  # Dispersion increases over normalized mean count, so use fitType = "local"
    # https://support.bioconductor.org/p/63244/
# Summarize results
Vbs.res <- results(Vbs, cooksCutoff=FALSE)
  # Bottom = Negative
  # Sediment = Positive
# Let's pull out all the OTUs that are overrepresented in Bottom
Vbs.df <- data.frame(Vbs.res)
bs.bot <- which(Vbs.df$log2FoldChange < 0)
bs.bot.otus <- rownames(Vbs.df[bs.bot,])
# Let's pull out all the OTUs that are overrepresented in Sediment
bs.sed <- which(Vbs.df$log2FoldChange > 0)
bs.sed.otus <- rownames(Vbs.df[bs.sed,])
# Getting ready to plot
alpha <- 0.01
sigtab <- Vbs.res[which(Vbs.res$padj < alpha),]
sigtab <- cbind(as(sigtab, "data.frame"), as(tax_table(Ver.bs)[rownames(sigtab),], "matrix"))
ggplot(sigtab, aes(x=Species, y=log2FoldChange, color=Class)) + geom_point() +
  scale_color_brewer (palette="Set1")


# Verrucos in Sediment vs. Top
Ver.st <- subset_samples(Ver.out.1, Depth != "Bottom")
Ver.st <- subset_samples(Ver.bs, Depth != "DCM")
# Create DESeq2 object
Vst <- phyloseq_to_deseq2(physeq = Ver.st, design = ~ Group+Season+Depth )
Vst <- DESeq(object = Vst, test="Wald", fitType="local")
plotDispEsts(object = Vst)
  # Dispersion increases over normalized mean count, so use fitType = "local"
    # https://support.bioconductor.org/p/63244/
# Summarize results
Vst.res <- results(Vst, cooksCutoff=FALSE)
  # Sediment = Negative
  # Top = Positive
# Let's pull out all the OTUs that are overrepresented in Sediment
Vst.df <- data.frame(Vst.res)
st.sed <- which(Vst.df$log2FoldChange < 0)
st.sed.otus <- rownames(Vst.df[st.sed,])

# Let's pull out all the OTUs that are overrepresented in Top
st.top <- which(Vst.df$log2FoldChange > 0)
st.top.otus <- rownames(Vst.df[st.top,])

# Getting ready to plot
alpha <- 0.01
sigtab <- Vst.res[which(Vst.res$padj < alpha),]
sigtab <- cbind(as(sigtab, "data.frame"), as(tax_table(Ver.out.1)[rownames(sigtab),], "matrix"))
ggplot(sigtab, aes(x=Species, y=log2FoldChange, color=Class)) + geom_point() +
  scale_color_brewer (palette="Set1")

sed.otus1 <- intersect(water.bot.otus, bs.sed.otus)
  # Which OTUs that prefer bottom, also prefer sed
sed.otus2 <- intersect(water.top.otus, st.sed.otus)
  # Which OTUs that prefer top, also prefer sed
sed.otus <- c(sed.otus1, sed.otus2)
  ## OTUs that are overrepresented in Sediment
bot.otus <- setdiff(water.bot.otus, bs.sed.otus)
  ## OTUs that are overrepresented in Bottom
top.otus <- setdiff(water.top.otus, st.sed.otus)
  ## OTUs that are overrepresented in Top



### Group
# Now let's isolate Verrucos in Estuary & Laurentian
Vg.el <- subset_samples(Ver.out.1, Group != "Inland")
# Create DESeq2 object
Vg.el.d <- phyloseq_to_deseq2(physeq = Vg.el, design = ~ Depth+Season+Group)
  # Depth & Fraction can't be controlled for together because they both include sediment
  # Not a big difference between controlling for one or the either
  # I'll choose to control for depth because that accounts for more of the variation
Vg.el.d <- DESeq(object = Vg.el.d, test="Wald", fitType="local")
plotDispEsts(object = Vg.el.d)
  # Dispersion increases over normalized mean count, so use fitType = "local"
    # https://support.bioconductor.org/p/63244/
# Summarize results
Vg.el.res <- results(Vg.el.d, cooksCutoff=FALSE)
  # Estuary = Negative
  # Laurentian = Positive

# Let's pull out all the OTUs that are overrepresented in Estuary
Ver.el <- data.frame(Vg.el.res)
Ver.el.est <- which(Ver.el$log2FoldChange < 0)
Ver.el.est.otus <- rownames(Ver.el[Ver.el.est,])

# Let's pull out all the OTUs that are overrepresented in Laurentian
Ver.el.lau <- which(Ver.el$log2FoldChange > 0)
Ver.el.lau.otus <- rownames(Ver.el[Ver.el.lau,])

# Getting ready to plot
alpha <- 0.01
sigtab <- Vg.el.res[which(Vg.el.res$padj < alpha),]
sigtab <- cbind(as(sigtab, "data.frame"), as(tax_table(Ver.out.1)[rownames(sigtab),], "matrix"))
ggplot(sigtab, aes(x=Species, y=log2FoldChange, color=Class)) + geom_point() +
  scale_color_brewer (palette="Set1")


# Now let's isolate Verrucos in Estuary & Inland
Vg.ei <- subset_samples(Ver.out.1, Group != "Laurentian")
# Create DESeq2 object
Vg.ei.d <- phyloseq_to_deseq2(physeq = Vg.ei, design = ~ Depth+Season+Group )
Vg.ei.d <- DESeq(object = Vg.ei.d, test="Wald", fitType="local")
plotDispEsts(object = Vg.ei.d)
  # Dispersion increases over normalized mean count, so use fitType = "local"
    # https://support.bioconductor.org/p/63244/
# Summarize results
Vg.ei.res <- results(Vg.ei.d, cooksCutoff=FALSE)
  # Estuary = Negative
  # Inland = Positive

# Let's pull out all the OTUs that are overrepresented in Estuary
Ver.ei <- data.frame(Vg.ei.res)
Ver.ei.est <- which(Ver.ei$log2FoldChange < 0)
Ver.ei.est.otus <- rownames(Ver.ei[Ver.ei.est,])

# Let's pull out all the OTUs that are overrepresented in Inland
Ver.ei.inl <- which(Ver.ei$log2FoldChange > 0)
Ver.ei.inl.otus <- rownames(Ver.ei[Ver.ei.inl,])

# Getting ready to plot
alpha <- 0.01
sigtab <- Vg.ei.res[which(Vg.ei.res$padj < alpha),]
sigtab <- cbind(as(sigtab, "data.frame"), as(tax_table(Ver.water)[rownames(sigtab),], "matrix"))
ggplot(sigtab, aes(x=Species, y=log2FoldChange, color=Class)) + geom_point() +
  scale_color_brewer (palette="Set1")


# Now let's isolate Verrucos in Laurentian & Inland
Vg.li <- subset_samples(Ver.out.1, Group != "Estuary")
# Create DESeq2 object
Vg.li.d <- phyloseq_to_deseq2(physeq = Vg.li, design = ~Depth+Season+Group )
Vg.li.d <- DESeq(object = Vg.li.d, test="Wald", fitType="local")
plotDispEsts(object = Vg.li.d)
  # Dispersion increases over normalized mean count, so use fitType = "local"
    # https://support.bioconductor.org/p/63244/
# Summarize results
Vg.li.res <- results(Vg.li.d, cooksCutoff=FALSE)
  # Inland = Negative
  # Laurentian = Positive

# Let's pull out all the OTUs that are overrepresented in Inland
Ver.li <- data.frame(Vg.li.res)
Ver.li.inl <- which(Ver.li$log2FoldChange < 0)
Ver.li.inl.otus <- rownames(Ver.li[Ver.li.inl,])

# Let's pull out all the OTUs that are overrepresented in Laurentian
Ver.li.lau <- which(Ver.li$log2FoldChange > 0)
Ver.li.lau.otus <- rownames(Ver.li[Ver.li.lau,])

# Getting ready to plot
alpha <- 0.01
sigtab <- Vg.li.res[which(Vg.li.res$padj < alpha),]
sigtab <- cbind(as(sigtab, "data.frame"), as(tax_table(Ver.water)[rownames(sigtab),], "matrix"))
ggplot(sigtab, aes(x=Species, y=log2FoldChange, color=Class)) + geom_point() +
  scale_color_brewer (palette="Set1")

est.otus <- intersect(Ver.el.est.otus, Ver.ei.est.otus)
inl.otus <- intersect(Ver.ei.inl.otus, Ver.li.inl.otus)
lau.otus <- intersect(Ver.el.lau.otus, Ver.li.lau.otus)




####### Fraction
# Now let's isolate Verrucos in Free & Particle (fractions, so no sediment but DCM is included)
Vfrac <- subset_samples(Ver.out.1, Fraction != "Sediment")

# Create DESeq2 object
Vfrac.d <- phyloseq_to_deseq2(physeq = Vfrac, design = ~ Depth+Group+Season+Fraction )
Vfrac.d <- DESeq(object = Vfrac.d, test="Wald", fitType="local")
plotDispEsts(object = Vfrac.d)
  # Dispersion increases over normalized mean count, so use fitType = "local"
    # https://support.bioconductor.org/p/63244/
# Summarize results
Vfrac.res <- results(Vfrac.d, cooksCutoff=FALSE)
  # Free = Negative
  # Particle = Positive

# Let's pull out all the OTUs that are overrepresented in Free
Vfrac.data <- data.frame(Vfrac.res)
V.free <- which(Vfrac.data$log2FoldChange < 0)
free.otus <- rownames(Vfrac.data[V.free,])

# Let's pull out all the OTUs that are overrepresented in Laurentian
V.part <- which(Vfrac.data$log2FoldChange > 0)
part.otus <- rownames(Vfrac.data[V.part,])

# Getting ready to plot
alpha <- 0.01
sigtab <- Vfrac.res[which(Vfrac.res$padj < alpha),]
sigtab <- cbind(as(sigtab, "data.frame"), as(tax_table(Vfrac)[rownames(sigtab),], "matrix"))
ggplot(sigtab, aes(x=Species, y=log2FoldChange, color=Class)) + geom_point() +
  scale_color_brewer (palette="Set1")






####### Season
# Now let's isolate Verrucos in Spring & Summer
V.ss <- subset_samples(Ver.out.1, Season != "Fall")
# Create DESeq2 object
V.ss.d <- phyloseq_to_deseq2(physeq = V.ss, design = ~ Depth+Group+Season )
V.ss.d <- DESeq(object = V.ss.d, test="Wald", fitType="local")
plotDispEsts(object = V.ss.d)
  # Dispersion increases over normalized mean count, so use fitType = "local"
    # https://support.bioconductor.org/p/63244/
# Summarize results
V.ss.res <- results(V.ss.d, cooksCutoff=FALSE)
  # Spring = Negative
  # Summer = Positive

# Let's pull out all the OTUs that are overrepresented in Free
V.ss.data <- data.frame(V.ss.res)
V.sp <- which(V.ss.data$log2FoldChange < 0)
V.sp.otus <- rownames(V.ss.data[V.sp,])

# Let's pull out all the OTUs that are overrepresented in Laurentian
V.su <- which(V.ss.data$log2FoldChange > 0)
V.su.otus <- rownames(V.ss.data[V.su,])

# Getting ready to plot
alpha <- 0.01
  # Significance level
sigtab <- V.ss.res[which(V.ss.res$padj < alpha),]
sigtab <- cbind(as(sigtab, "data.frame"), as(tax_table(V.ss)[rownames(sigtab),], "matrix"))
ggplot(sigtab, aes(x=Species, y=log2FoldChange, color=Class)) + geom_point() +
  scale_color_brewer (palette="Set1")





# Now let's isolate Verrucos in Spring & Fall
V.spf <- subset_samples(Ver.out.1, Season != "Summer")
# Create DESeq2 object
V.spf.d <- phyloseq_to_deseq2(physeq = V.spf, design = ~ Depth+Group+Season )
V.spf.d <- DESeq(object = V.spf.d, test="Wald", fitType="local")
plotDispEsts(object = V.spf.d)
  # Dispersion increases over normalized mean count, so use fitType = "local"
    # https://support.bioconductor.org/p/63244/
# Summarize results
V.spf.res <- results(V.spf.d, cooksCutoff=FALSE)
  # Fall = Negative
  # Spring = Positive

# Let's pull out all the OTUs that are overrepresented in Free
V.spf.data <- data.frame(V.spf.res)
V.spf.fa <- which(V.spf.data$log2FoldChange < 0)
V.spf.fa.otus <- rownames(V.spf.data[V.spf.fa,])

# Let's pull out all the OTUs that are overrepresented in Laurentian
V.spf.sp <- which(V.spf.data$log2FoldChange > 0)
V.spf.sp.otus <- rownames(V.spf.data[V.spf.sp,])

# Getting ready to plot
alpha <- 0.01
sigtab <- V.spf.res[which(V.spf.res$padj < alpha),]
sigtab <- cbind(as(sigtab, "data.frame"), as(tax_table(V.spf)[rownames(sigtab),], "matrix"))
ggplot(sigtab, aes(x=Species, y=log2FoldChange, color=Class)) + geom_point() +
  scale_color_brewer (palette="Set1")




# Now let's isolate Verrucos in Summer & Fall
V.suf <- subset_samples(Ver.out.1, Season != "Spring")
# Create DESeq2 object
V.suf.d <- phyloseq_to_deseq2(physeq = V.suf, design = ~ Depth+Group+Season )
V.suf.d <- DESeq(object = V.suf.d, test="Wald", fitType="local")
plotDispEsts(object = V.suf.d)
  # Dispersion increases over normalized mean count, so use fitType = "local"
    # https://support.bioconductor.org/p/63244/
# Summarize results
V.suf.res <- results(V.suf.d, cooksCutoff=FALSE)
  # Fall = Negative
  # Summer = Positive

# Let's pull out all the OTUs that are overrepresented in Free
V.suf.data <- data.frame(V.suf.res)
V.suf.fa <- which(V.suf.data$log2FoldChange < 0)
V.suf.fa.otus <- rownames(V.suf.data[V.suf.fa,])

# Let's pull out all the OTUs that are overrepresented in Laurentian
V.suf.su <- which(V.suf.data$log2FoldChange > 0)
V.suf.su.otus <- rownames(V.suf.data[V.suf.su,])

# Getting ready to plot
alpha <- 0.01
sigtab <- V.suf.res[which(V.suf.res$padj < alpha),]
sigtab <- cbind(as(sigtab, "data.frame"), as(tax_table(V.suf)[rownames(sigtab),], "matrix"))
ggplot(sigtab, aes(x=Species, y=log2FoldChange, color=Class)) + geom_point() +
  scale_color_brewer (palette="Set1")

sp.otus <- intersect(V.sp.otus,V.spf.sp.otus)
su.otus <- intersect(V.su.otus,V.suf.su.otus)
fa.otus <- intersect(V.spf.fa.otus,V.suf.fa.otus)
```



### Create ecoIDs
```{r ecoID}
#http://stackoverflow.com/questions/10298662/find-elements-not-in-smaller-character-vector-list-but-in-big-list
Ver.otus <- rownames(tax_table(Ver.out.1))

Group.label <- rownames(tax_table(Ver.out.1))
Group.label[Group.label %in% est.otus] <- paste("E", Group.label[Group.label %in% est.otus])
Group.label[Group.label %in% inl.otus] <- paste("I", Group.label[Group.label %in% inl.otus])
Group.label[Group.label %in% lau.otus] <- paste("L", Group.label[Group.label %in% lau.otus])
# 1244 labels; 79 OTUs have no preference

Depth.label <- rownames(tax_table(Ver.out.1))
Depth.label[Depth.label %in% bot.otus] <- paste("B", Depth.label[Depth.label %in% bot.otus])
Depth.label[Depth.label %in% sed.otus] <- paste("S", Depth.label[Depth.label %in% sed.otus])
Depth.label[Depth.label %in% top.otus] <- paste("T", Depth.label[Depth.label %in% top.otus])
# 1323 labels; all OTUs have preference

Fraction.label <- rownames(tax_table(Ver.out.1))
Fraction.label[Fraction.label %in% free.otus] <- paste("F", Fraction.label[Fraction.label %in%
                                                                             free.otus])
Fraction.label[Fraction.label %in% part.otus] <- paste("P", Fraction.label[Fraction.label %in%
                                                                             part.otus])
# 1323 labels; all OTUs have preference

Season.label <- rownames(tax_table(Ver.out.1))
Season.label[Season.label %in% sp.otus] <- paste("C_", Season.label[Season.label %in% sp.otus])
Season.label[Season.label %in% su.otus] <- paste("V_", Season.label[Season.label %in% su.otus])
Season.label[Season.label %in% fa.otus] <- paste("A_", Season.label[Season.label %in% fa.otus])
# 1320 labels; 3 OTUs have no preference

group.split <- data.frame(strsplit(Group.label, " "), stringsAsFactors=FALSE)
colnames(group.split) <- Ver.otus
depth.split <- data.frame(strsplit(Depth.label, " "), stringsAsFactors=FALSE)
colnames(depth.split) <- Ver.otus
fraction.split <- data.frame(strsplit(Fraction.label, " "), stringsAsFactors=FALSE)
colnames(fraction.split) <- Ver.otus
season.split <- data.frame(strsplit(Season.label, " "), stringsAsFactors=FALSE)
colnames(season.split) <- Ver.otus
group.split[3,] <- depth.split[1,]
group.split[4,] <- fraction.split[1,]
group.split[5,] <- season.split[1,]
group.split <- group.split[-2,]
# Now to rename the OTUs with no preference in one of the ecological factors
nopref <- which(substr(group.split[1,],1,1) == "O")
group.split[1,nopref] <- 0
nopref <- which(substr(group.split[2,],1,1) == "O")
group.split[2,nopref] <- 0
nopref <- which(substr(group.split[3,],1,1) == "O")
group.split[3,nopref] <- 0
nopref <- which(substr(group.split[4,],1,1) == "O")
group.split[4,nopref] <- "0_"
group.split[5,] <- paste(group.split[2,], group.split[1,], group.split[3,], group.split[4,],
                         colnames(group.split))
write.csv(group.split[5,], file="Ecology_Otu", row.names=FALSE, quote=FALSE)
```

### Create updated phyloseq object with EcoID
```{r ecoid.phyloseq}
##### Create new phyloseq object with EcoIDs
eco.label<- read.csv("Ecology_Otu", header=F)
eco.label <- t(eco.label)
otu <- otu_table(Ver.out.1)
samp <- sample_data(Ver.out.1)
tax <- data.frame(tax_table(Ver.out.1))
tax$EcoID <- eco.label
group.split <- t(group.split)
tax$Pref.Depth <- group.split[,3]
tax$Pref.Group <- group.split[,1]
tax$Pref.Fraction <- group.split[,4]
tax$Pref.Season <- group.split[,5]
tax <- as.matrix(tax)
tax <- tax_table(tax)
eco.ver <- merge_phyloseq(otu, samp, tax)
newick <- read.newick(file="ver.outgroup.tre")
  # Outgroup = Planctomycetes Otu000037
newick_phy <- phy_tree(newick)
#test <- import_mothur(mothur_tree_file=newick)
Ver.tree<-merge_phyloseq(eco.ver,newick_phy)
#plot_tree(Ver.tree, color="Class")
Ver.50 <- prune_taxa(mostabund.names, Ver.tree)
#plot_tree(Ver.50, color="Class")
```

### Create labels for IToL!
```{r, itol}
### IToL Label Functions
color.id <- function(x) {
  ifelse(grepl("OPB35_soil_group",x),"#e41a1c",
  ifelse(grepl("Opitutae",x), "#377eb8",
  ifelse(grepl("Spartobacteria",x), "#4daf4a",
  ifelse(grepl("S-BQ2-57_soil_group",x), "#984ea3",
  ifelse(grepl("Verrucomicrobia_Incertae_Sedis",x), "#ff7f00",
  ifelse(grepl("Verrucomicrobiae",x), "#ffd92f",
  ifelse(grepl("unclassified",x), "#a65628",
  ifelse(grepl("UA11",x), "#f781bf",
         NA))))))))
}

depth.id <- function(x) {
  depth <- substr(x$EcoID,1,1)
  ifelse(grepl("T",depth), "1,-1,-1",
  ifelse(grepl("B",depth), "-1,1,-1",
  ifelse(grepl("S",depth), "-1,-1,1",
  ifelse(grepl("0",depth), "-1,-1,-1",
  NA))))
}

group.id <- function(x) {
  group <- substr(x$EcoID,2,2)
  ifelse(grepl("E",group), "1,-1,-1",
  ifelse(grepl("I",group), "-1,1,-1",
  ifelse(grepl("L",group), "-1,-1,1",
  ifelse(grepl("0", group), "-1,-1,-1",
  NA))))
}

fraction.id <- function(x) {
  fraction <- substr(x$EcoID,3,3)
  ifelse(grepl("F",fraction), "1,-1",
  ifelse(grepl("P",fraction), "-1,1",
  ifelse(grepl("0",fraction), "-1,-1",
  NA)))
}

season.id <- function(x) {
  season <- substr(x$EcoID,4,4)
  ifelse(grepl("C",season), "1,-1,-1",
  ifelse(grepl("V",season), "-1,1,-1",
  ifelse(grepl("A",season), "-1,-1,1",
  ifelse(grepl("0", season), "-1,-1,-1",
  NA))))
}

### Create IToL COLOR labels
Ver.only <- prune_taxa(names(taxa_sums(Ver.tree)) != "Otu000037", x=Ver.tree)
all <- data.frame(tax_table(Ver.only))
color.all <- data.frame(all$Species)
color.all$Class <- all$Class
color.all$color <- color.id(color.all$Class)
color.all$label <- paste(color.all$all.Species,"range",color.all$color,color.all$Class)
write.csv(color.all$label,file="all.ver.color",row.names=FALSE,quote=FALSE)

### Create IToL ECOID Labels
ecoid.all <- data.frame(all$Species)
ecoid.all$EcoID <- all$EcoID
depth.itol <- depth.id(ecoid.all)
ecoid.all$depth.label <- depth.itol
group.itol <- group.id(ecoid.all)
ecoid.all$group.label <- group.itol
fraction.itol <- fraction.id(ecoid.all)
ecoid.all$fraction.label <- fraction.itol
season.itol <- season.id(ecoid.all)
ecoid.all$season.label <- season.itol
ecoid.all$itol.label <- paste(ecoid.all$all.Species, ecoid.all$depth.label, ecoid.all$group.label,
                              ecoid.all$fraction.label, ecoid.all$season.label)
write.csv(ecoid.all$itol.label,"EcoID.IToL.label", row.names=FALSE, quote=FALSE)
```

### Create dataset for ITOL for top 100 Verruco OTUS
```{r ITOL.100}
# Subset out top 100 most abundant Verruco OTUs
top100ver = sort(taxa_sums(Ver.only), TRUE)[1:100]
print(top100ver)
top100ver.names<-names(top100ver)

Ver.100 <- prune_taxa(mostabund.names, Ver.only)
#write.tree(phy_tree(Ver.100), file="Ver.100.tre")
```



### Extra Functions
```{r}
################# FUNCTION TO FIND NAS IN A DATAFRAME #################
nacols <- function(df) {
  colnames(df)[unlist(lapply(df, function(x) any(is.na(x))))]
}

deSEQ <- function(data, valuetest, cutoff = 0, alpha = 0.01){
  data_pruned <- prune_taxa(taxa_sums(data) > cutoff, data)
  de_data <- phyloseq_to_deseq2(data_pruned, valuetest)
  de_data2 <- DESeq(de_data, test="Wald", fitType="local")
  res_data <- results(de_data2, cooksCutoff = FALSE)
  sig_data <- res_data[which(res_data$padj < alpha), ]
  sigtab_sherm <- cbind(as(sig_data, "data.frame"), as(tax_table(data_pruned)[rownames(sig_data), ], "matrix"))
} 

plot_deSEQ <- function(deSEQdata, title){
  y = tapply(deSEQdata$log2FoldChange, deSEQdata$Genus, function(x) max(x))
  y = sort(y, TRUE)
  deSEQdata$Genus = factor(as.character(deSEQdata$Genus), levels=names(y))
  ggplot(deSEQdata, aes(x=Genus, y=log2FoldChange, color=Phylum)) + 
    geom_point(size=6) +  ggtitle(title) +  
    scale_color_manual(values = phylum.colors,name="Phylum") +
    scale_y_continuous(breaks=seq(-15,15,1)) + 
    theme(axis.title.x = element_text(face="bold", size=16),
          axis.text.x = element_text(angle=30, colour = "black", vjust=1, hjust = 1, size=12),
          axis.text.y = element_text(colour = "black", size=16),
          axis.title.y = element_text(face="bold", size=16),
          plot.title = element_text(face="bold", size = 20),
          legend.title = element_text(size=12, face="bold"),
          legend.text = element_text(size = 12),
          strip.background = element_rect(colour="black"),
          legend.position="right")
}



phyloseq_to_adonis <- function(physeq, distmat = NULL, dist = "bray", formula) {
  if(!is.null(distmat)){
    phydist <- distmat
  } else {
    phydist <- phyloseq::distance(physeq, dist)
  }
  metadata <- as(sample_data(physeq), "data.frame")
  
  # Adonis test
  f <- reformulate(formula, response = "phydist")
  adonis.test <- adonis(f, data = metadata)
  print(adonis.test)
  
  # Run homogeneity of dispersion test if there is only 1 variable
  if (length(formula) == 1) {
    group <- metadata[,formula]
    beta <- betadisper(phydist, group)
    disper.test = permutest(beta)
    print(disper.test)
  
    l <- list(
      dist = phydist, 
      formula = f, 
      adonis = adonis.test, 
      disper = disper.test
    )
    
  } else {
    
    l <- list(
      dist = phydist, 
      formula = f, 
      adonis = adonis.test
    )
  }
  return (l)
}
```

